# MUEDnote v7 iOS 実機テスト記録

**日付**: 2025-12-22
**フェーズ**: MVP 実機テスト

---

## 実施内容

iOS 実機（iPhone）での E2E 動作確認を実施。

### テスト環境

| 項目 | 内容 |
|------|------|
| デバイス | iPhone（有線接続、デベロッパーモード） |
| Whisper モデル | ggml-small.bin (465MB) |
| VAD | 未使用（モデル未追加） |
| サーバー | mued_v2 (Next.js 16, localhost:3000) |

---

## 結果サマリー

| 機能 | 状態 | 備考 |
|------|------|------|
| アプリ起動 | ✅ | Xcode ビルド成功 |
| Whisper 初期化 | ✅ | モデルロード成功 |
| セッション開始/終了 | ✅ | タイマー動作確認 |
| リアルタイム文字起こし | ✅ | 日本語認識動作 |
| ハルシネーションフィルター | ✅ | (音楽)、ご視聴ありがとう等を除去 |
| ローカル保存 | ✅ | AsyncStorage |
| サーバー同期 | ✅ | Neon DB に保存確認 |

---

## 発見された課題

### 1. メモリ問題（解決済み）
- **症状**: 長時間録音でメモリ不足クラッシュ
- **原因**: Whisper small モデル (465MB) + リアルタイム処理
- **対策**:
  - bufferSize: 16KB → 8KB
  - audioSliceSec: 15秒 → 10秒
  - maxSpeechDurationS: 30秒 → 15秒
  - sliceTexts Map を最新10件のみ保持

### 2. Whisper ハルシネーション（軽減済み）
- **症状**: 無音時に「ご視聴ありがとうございました」「(音楽)」等を誤認識
- **対策**: 正規表現フィルターを追加
  ```typescript
  const HALLUCINATION_PATTERNS = [
    /^[\(（].*[\)）]$/,  // 括弧のみ
    /ご視聴ありがとう/,
    /字幕を押して/,
    /チャンネル登録/,
    // ...
  ];
  ```

### 3. 日本語認識精度
- **症状**: 「どうだ」→「ドゥダ」、環境音を「スパイシー」と誤認識
- **状態**: 未解決（Whisper モデルの限界）
- **今後**: VAD 追加、prompt チューニングで改善可能

### 4. timestamp_sec が常に 0
- **症状**: ログの timestamp_sec がすべて 0
- **状態**: 軽微、後日修正

---

## 技術的な対応

### prebuild 時の設定追加

**app.json**:
```json
{
  "expo": {
    "scheme": "muednote",  // 追加必須
    ...
  }
}
```

### アセットファイル
- `ios/MUEDnote/models/ggml-small.bin` を Xcode で追加
- Target Membership: MUEDnote のみ（ShareExtension は不要）

### API 開発用認証
- sessions/route.ts, logs/route.ts に開発用トークン認証を追加
- `DEV_TOKEN = 'dev_token_kimny'`
- 本番では `NODE_ENV !== 'development'` で無効化

### モバイル API URL
- iPhone から localhost はアクセス不可
- 開発時は Mac の IP アドレスを使用: `http://192.168.0.4:3000`

---

## DB 保存確認

### セッション
```json
{
  "id": "6e19b4cf-fd85-44a3-9107-ce5a2f4667c4",
  "userId": "dev_user_kimny",
  "durationSec": 79,
  "status": "synced"
}
```

### ログ（7件）
- 音声認識結果が正常に保存されていることを確認

---

## 次のステップ

1. **VAD モデル追加** - 音声活動検出で精度向上
2. **timestamp_sec 修正** - 各ログの開始時間を正しく記録
3. **長時間セッションテスト** - 5分、60分でメモリ安定性確認
4. **UI 改善** - タイマー終了時の挙動、ログ表示の改善

---

## 結論

**MVP として基本的なデータフローが完成。**

音声認識 → リアルタイム文字起こし → ローカル保存 → サーバー同期

の一連の流れが実機で動作することを確認した。

---

## 追加テスト: バッチ処理方式への移行（同日午後）

### 背景

PoC セッション3 の結論「タイマー連動ならバッチ処理が最適」に基づき、リアルタイム処理からバッチ処理に移行。

### 変更内容

| 変更前 | 変更後 |
|--------|--------|
| VAD + RealtimeTranscriber | expo-av 録音のみ |
| 録音中に随時文字起こし | セッション終了後にまとめて処理 |
| 複雑なメモリ管理 | シンプルな録音→処理フロー |

### 実装変更

| ファイル | 変更内容 |
|---------|---------|
| whisperService.ts | RealtimeTranscriber 削除、バッチ transcribe() 実装 |
| SessionScreen.tsx | VAD表示削除、録音インジケーターのみ |
| ReviewScreen.tsx | 文字起こし処理をここに移動 |
| sessionStore.ts | VAD関連状態削除 |
| storage.ts | 完了済みセッションへのログ追加対応 |

### 追加修正

| 項目 | 内容 |
|------|------|
| 重複除去 | Set で同一テキスト除去（51件→8件、85%削減） |
| ハルシネーション | 全体除外→部分除去に変更（実発話を保持） |
| ATS設定 | Info.plist に 192.168.0.4 の HTTP 例外追加 |
| DB同期フロー | 音声共有前に同期完了（データ安全性確保） |
| log_count | sessions API のサブクエリを LEFT JOIN に修正 |

### テスト結果

| 機能 | 状態 | 備考 |
|------|------|------|
| バッチ録音 | ✅ | expo-av WAV 16kHz mono |
| バッチ文字起こし | ✅ | 約4-7秒 |
| 重複除去 | ✅ | 85%削減 |
| DB同期 | ✅ | 8件のログ正常保存 |
| 音声共有 | ✅ | iOS共有シート経由 |

### DB保存確認（バッチ処理後）

```
Session: c173b0f1 (84秒, synced)
Logs: 8件（重複除去後）
```

---

## Phase 1 完了

**MVP コアフロー完成**:

```
アプリ起動 → タイマー設定 → 録音 → 文字起こし → DB同期
```

バッチ処理方式への移行により、シンプルで安定した実装を実現。

---

*記録: 2025-12-22*
