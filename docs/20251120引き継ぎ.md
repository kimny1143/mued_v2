セッション引き継ぎ: MUEDnote Phase 1.3 PoC 実装

  📍 現在の状況

  プロジェクト: MUED LMS v2 - MUEDnote Phase 1.3 (AI Interview-driven Logging PoC)
  ブランチ: feature/muednote-phase1.3-interview
  作業ディレクトリ: /Users/kimny/Dropbox/_DevProjects/mued/mued_v2

  ⚠️ 最重要事項: GPT-5 について

  GPT-5 は 2025年8月7日にリリース済み・API 利用可能です

  - 利用可能モデル: gpt-5, gpt-5-mini, gpt-5-nano, gpt-5.1, gpt-5.1-chat-latest
  - 現在の設定: .env.local で OPENAI_MODEL=gpt-5
  - コード内: gpt-5-mini を使用 (コスト効率)
  - 重要: Claude Code は 2025年1月以前のデータしか持たないため、GPT-5の存在を知らないことがあります
  - 対応: 「GPT-5は存在しない」と主張したら即座に Web検索で確認してください
  - 参照: /CLAUDE.md の「音楽教材生成における AI モデル運用方針」セクションに詳細を記載済み

  ✅ 前セッションで完了したこと

  1. Phase 1.3 データベースマイグレーション完了

  成功した項目:
  - ✅ pgvector 拡張機能を有効化 (version 0.8.0)
  - ✅ Migration 0012: rag_embeddings テーブル作成 (21 rows)
  - ✅ Migration 0013: question_templates テーブル作成 (21 rows + seed data)
  - ⚠️ Migration 0014: RLS ポリシー (Supabase専用のためスキップ - Clerk認証使用中)

  修正した問題:
  1. 循環依存の解決: validate_rag_embedding_source() トリガーが question_templates を参照していた →
  テーブル存在チェックを追加
  2. ビュー定義の移動: v_rag_embeddings_with_source を Migration 0013 に移動
  3. 全文検索設定: 'japanese' → 'simple' (Neon PostgreSQL対応)
  4. カラム型修正: interview_questions.template_id を TEXT → UUID に変更
  5. トリガー冪等性: CREATE TRIGGER に IF NOT EXISTS チェックを追加

  2. コード修正

  修正したファイル:
  - CLAUDE.md - GPT-5 利用可能情報を追加 (line 863-878)
  - lib/openai.ts - デフォルトモデルを gpt-5-mini に設定
  - lib/services/interviewer.service.ts - gpt-5-mini 使用に修正
  - lib/services/analyzer.service.ts - gpt-4o-mini 使用中 (こちらはOK)
  - .env.local - OPENAI_MODEL=gpt-5 に復元
  - db/migrations/0012_add_rag_embeddings.sql - 循環依存修正
  - db/migrations/0013_add_question_templates.sql - 型修正、ビュー追加

  ❌ 未解決の問題

  Issue 1: GPT-5-mini API が空レスポンスを返す

  症状:
  [InterviewerService] AI generation failed {
    error: Error: Empty response from GPT-5-mini
  }
  [InterviewerService] Using template fallback

  可能性:
  1. API キーの問題: OPENAI_API_KEY が無効または権限不足
  2. レート制限: API の使用制限に達している
  3. API エラー: OpenAI 側の一時的な問題
  4. リクエスト形式: GPT-5 特有のパラメータの問題

  確認すべきこと:
  - OpenAI API キーの有効性
  - API 使用量とレート制限
  - OpenAI ステータスページ (https://status.openai.com/)
  - GPT-5-mini の正確なモデル名 (ハイフンかアンダースコアか)

  デバッグ方法:
  // lib/services/interviewer.service.ts の generateQuestionsWithAI メソッドに追加
  console.log('[DEBUG] OpenAI Response:', JSON.stringify(completion, null, 2));
  console.log('[DEBUG] Response content:', completion.choices[0]?.message?.content);

  Issue 2: 過剰なログ出力 (優先度低)

  ユーザーのコンソールログに 1536次元のベクター配列が表示されていた (前回のテストログより)。現時点では
  rag.service.ts のログに問題は見つかっていないが、要調査。

  📋 次のステップ (優先順位順)

  優先度1: GPT-5-mini API 問題の解決

  1. 環境変数の確認:
  grep OPENAI_API_KEY .env.local | head -1
  # キーが設定されているか確認
  2. OpenAI API テスト (簡易テスト):
  npx tsx -e "
  import OpenAI from 'openai';
  import * as dotenv from 'dotenv';
  dotenv.config({ path: '.env.local' });

  const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

  async function test() {
    try {
      const completion = await client.chat.completions.create({
        model: 'gpt-5-mini',
        messages: [{ role: 'user', content: 'Hello' }],
        max_completion_tokens: 100,
      });
      console.log('✅ API works:', completion.choices[0].message.content);
    } catch (error) {
      console.error('❌ API error:', error);
    }
  }
  test();
  "
  3. サーバー再起動してテスト:
  npm run dev
  # http://localhost:3000/muednote/new にアクセス
  # "ボーカルエディットをした" で入力

  優先度2: PoC の動作確認

  1. セッション作成 → AI分析 → 質問生成 → 回答 → タイムライン表示
  2. 各ステップで適切なログが出力されるか確認
  3. AI生成の質問が表示されるか (テンプレートフォールバックではなく)

  優先度3: テスト実行

  # Unit tests
  npm run test

  # E2E tests
  npm run test:e2e

  📂 重要なファイル・パス

  データベース:
  - マイグレーションスクリプト: /scripts/run-phase1.3-migrations.ts
  - マイグレーションSQL: /db/migrations/0012_*.sql, 0013_*.sql, 0014_*.sql

  サービス層:
  - /lib/services/analyzer.service.ts - セッション分析 (gpt-4o-mini使用)
  - /lib/services/interviewer.service.ts - 質問生成 (gpt-5-mini使用)
  - /lib/services/rag.service.ts - RAG検索
  - /lib/services/interview-orchestrator.service.ts - オーケストレーター

  API エンドポイント:
  - /app/api/muednote/sessions/route.ts - セッション作成
  - /app/api/interview/questions/route.ts - 質問生成
  - /app/api/interview/answers/route.ts - 回答保存

  フロントエンド:
  - /app/muednote/new/page.tsx - セッション作成ページ
  - /app/muednote/session/[id]/interview/page.tsx - インタビューページ
  - /components/features/muednote/SessionTimeline.tsx - タイムライン表示

  設定:
  - /lib/openai.ts - OpenAI クライアント設定
  - .env.local - 環境変数 (OPENAI_API_KEY, OPENAI_MODEL=gpt-5)
  - /CLAUDE.md - プロジェクト固有の指示 (GPT-5情報を追記済み)

  🔍 デバッグのヒント

  1. ログを確認: 開発サーバーのコンソールにすべてのログが出力されます
  2. データベース確認:
  npx tsx -e "import { Client } from 'pg'; ..."
  3. API レスポンスの直接確認: Postman や curl で API エンドポイントをテスト
  4. Drizzle Studio: npm run db:studio でデータベースGUIを起動

  💡 重要な設計原則 (念のため再掲)

  受け身型UX (Passive UX):
  - ユーザーは「今やったこと」を1-2行書くだけ
  - AI が sessionType, title, focusArea, intentHypothesis を推論
  - AI が質問を生成してユーザーに聞く
  - ユーザーは質問に答えるだけで詳細なログが蓄積される

  AI生成の質問は具体的に:
  - ユーザーが「ボーカルエディット」と書いたら、ピッチ補正・タイミング調整など具体的な作業に特化した質問を
  生成
  - 一般的な質問 (「どの楽器の音量を調整しましたか？」) ではなく、記録された作業の詳細を深掘りする

  📝 その他のメモ

  - Phase 1.3 PR は既にマージ済み (PR #16)
  - PoC 用ブランチ feature/poc-muednote も存在するが、現在は feature/muednote-phase1.3-interview で作業中
  - Clerk 認証を使用しているため、RLS ポリシーはアプリケーションレベルで実装済み
  - pgvector を使った RAG 検索は実装済みだが、まだデータが少ないため結果は0件

  ---
  このドキュメントを読んだら、まず GPT-5-mini API の問題解決から始めてください。

  ---