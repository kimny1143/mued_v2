# éŸ³æ¥½æ•™æç”Ÿæˆæ©Ÿèƒ½ - æŠ€è¡“ä»•æ§˜æ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 3.0
**æœ€çµ‚æ›´æ–°:** 2025-10-27
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆMVPè¨­è¨ˆå®Œäº†

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### è£½å“ã®æœ¬è³ª

**ã€ŒAIãŒæ•™æã‚’ä½œã‚‹ã€ã§ã¯ãªãã€ŒAIãŒå­¦ç¿’ã‚’å‰ã«é€²ã‚ã‚‹ã€**

MUED LMSã¯ã€AIç”ŸæˆæŠ€è¡“ã‚’ç”¨ã„ã¦**å­¦ç¿’è€…ã®ä»Šæ—¥ã®1ãƒŸãƒªã‚’æ”¯æ´ã™ã‚‹**éŸ³æ¥½æ•™è‚²ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚
æ•™æã®ç¾ã—ã•ã§ã¯ãªãã€**å­¦ç¿’åŠ¹æœã®è¨ˆæ¸¬ã¨æ”¹å–„**ã‚’ä¸­å¿ƒã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®3æœ¬æŸ±

1. **å­¦ç¿’ä¾¡å€¤ã®æ‹…ä¿** - ç”Ÿæˆç‰©ã¯æ•™è‚²çš„åŠ¹æœã‚’æ•°å€¤ã§æ¤œè¨¼
2. **æŠ€è¡“ã®å …ç‰¢æ€§** - å°åˆ·ãƒ»å†ç”Ÿãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®ç¢ºå®Ÿæ€§
3. **ä½¿ã„ã‚„ã™ã•ã®å¾¹åº•** - 3ãƒœã‚¿ãƒ³ä¸»ç¾©ã§èªçŸ¥è² è·ã‚’æœ€å°åŒ–

---

## 1. æ•™è‚²ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¨ã—ã¦ã®æˆç«‹æ€§

### 1.1 å­¦ç¿’KPIï¼ˆæ¸¬å®šå¯èƒ½ãªå­¦ç¿’åŠ¹æœï¼‰

æ•™æã®ã€Œæ­£ã—ã•ã€ã§ã¯ãªãã€Œå­¦ç¿’è€…ãŒé€²ã‚“ã ã‹ã€ã‚’æ¸¬å®šã—ã¾ã™ã€‚

#### è¨ˆæ¸¬æŒ‡æ¨™ï¼ˆV1å®Ÿè£…ï¼‰

| KPI | å®šç¾© | è¨ˆæ¸¬æ–¹æ³• | ç›®æ¨™å€¤ |
|-----|------|---------|--------|
| **é”æˆç‡** | ã‚»ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†ã®å‰²åˆ | å®Œäº†ãƒ•ãƒ©ã‚°ï¼ˆè‡ªå‹•/æ‰‹å‹•ï¼‰ | > 70% |
| **åå¾©æŒ‡æ•°** | åŒä¸€ãƒ‘ãƒ¼ãƒˆã®ç¹°ã‚Šè¿”ã—å›æ•° | å†ç”Ÿå›æ•°ã‚«ã‚¦ãƒ³ãƒˆ | 3-5å›ãŒç†æƒ³ |
| **ãƒ†ãƒ³ãƒåˆ°é”** | æŒ‡å®šBPMã¸ã®åˆ°é”ç‡ | é€Ÿåº¦è¨­å®šã®å±¥æ­´ | > 80% |
| **æ»åœ¨ç®‡æ‰€** | ãƒ«ãƒ¼ãƒ—ãŒå¤šã„å°ç¯€ï¼ˆè‹¦æ‰‹æ¤œå‡ºï¼‰ | ãƒ«ãƒ¼ãƒ—é¸æŠã®é »åº¦ | ä¸Šä½3å°ç¯€ã‚’ç‰¹å®š |

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

```sql
-- å­¦ç¿’ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆæ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
CREATE TABLE learning_metrics (
  id UUID PRIMARY KEY,
  material_id UUID REFERENCES ai_materials(id),
  user_id UUID REFERENCES users(id),
  section_id TEXT,           -- "warmup", "drill_1" ãªã©
  completed BOOLEAN DEFAULT FALSE,
  repetition_count INT DEFAULT 0,
  tempo_achieved INT,        -- åˆ°é”BPM
  loop_sections JSONB,       -- [{"bar": 5, "count": 12}, ...]
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ai_materials ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ
ALTER TABLE ai_materials
  ADD COLUMN notation TEXT,              -- ABCè¨˜æ³•ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
  ADD COLUMN metadata JSONB,             -- æ‹¡å¼µãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  ADD COLUMN quality JSONB,              -- æ•™æå“è³ªã‚¹ã‚³ã‚¢ï¼ˆæ–°è¦ï¼‰
  ADD COLUMN format_version TEXT DEFAULT '3.0';
```

#### å“è³ªã‚¹ã‚³ã‚¢ï¼ˆqualityåˆ—ï¼‰

```json
{
  "learning_value_score": 8.2,
  "playability_score": 9.1,
  "range_ok": true,
  "leap_mean": 3.2,
  "chromatic_density": 0.15,
  "repetition_ratio": 0.4,
  "tempo_qpm": 120,
  "difficulty_delta": 1.2,
  "validation_passed": true,
  "review_status": "approved"
}
```

### 1.2 æ•™æã®ã€Œæ•™è‚²ä¾¡å€¤ã€å¯©æŸ»

ç”Ÿæˆç›´å¾Œã«**ã€Œæ§‹æ–‡OKã€ã§ã¯ãªãã€Œå­¦ç¿’ä¾¡å€¤ã‚¹ã‚³ã‚¢ > é–¾å€¤ã€**ã‚’é€šéã—ãªã„ã¨å…¬é–‹ã—ã¾ã›ã‚“ã€‚

#### analyzeAbc() é–¢æ•°ï¼ˆæ–°è¦å®Ÿè£…ï¼‰

```typescript
// lib/abc-analyzer.ts
interface AbcAnalysis {
  learning_value_score: number;  // ç·åˆã‚¹ã‚³ã‚¢ (0-10)
  playability_score: number;     // æ¼”å¥å¯èƒ½æ€§ (0-10)
  range_ok: boolean;             // éŸ³åŸŸãƒã‚§ãƒƒã‚¯
  leap_mean: number;             // å¹³å‡è·³èºå¹…ï¼ˆåŠéŸ³å˜ä½ï¼‰
  chromatic_density: number;     // åŠéŸ³éšç§»å‹•ã®å¯†åº¦
  repetition_ratio: number;      // åå¾©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‰²åˆ
  tempo_qpm: number;             // ãƒ†ãƒ³ãƒï¼ˆQPMï¼‰
  difficulty_delta: number;      // å‰èª²é¡Œã‹ã‚‰ã®é›£æ˜“åº¦å·®
}

export function analyzeAbc(
  abc: string,
  instrument: string,
  previousMaterial?: AbcAnalysis
): AbcAnalysis {
  const notes = parseAbcNotes(abc);

  // éŸ³åŸŸãƒã‚§ãƒƒã‚¯ï¼ˆæ¥½å™¨ã”ã¨ã®å¯å¥åŸŸï¼‰
  const range = getInstrumentRange(instrument);
  const range_ok = notes.every(n => n >= range.min && n <= range.max);

  // è·³èºå¹…ã®è¨ˆç®—
  const leaps = notes.slice(1).map((n, i) => Math.abs(n - notes[i]));
  const leap_mean = leaps.reduce((a, b) => a + b, 0) / leaps.length;

  // åŠéŸ³éšå¯†åº¦ï¼ˆã‚¯ãƒ­ãƒãƒãƒƒã‚¯åº¦ï¼‰
  const chromatic_density = leaps.filter(l => l === 1).length / leaps.length;

  // åå¾©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º
  const repetition_ratio = detectRepetitionPatterns(notes);

  // ãƒ†ãƒ³ãƒæŠ½å‡º
  const tempo_qpm = extractTempo(abc) || 120;

  // é›£æ˜“åº¦å·®ï¼ˆå‰èª²é¡Œã¨ã®æ¯”è¼ƒï¼‰
  const difficulty_delta = previousMaterial
    ? calculateDifficultyDelta(
        { leap_mean, chromatic_density, tempo_qpm },
        previousMaterial
      )
    : 1.0;

  // æ¼”å¥å¯èƒ½æ€§ã‚¹ã‚³ã‚¢ï¼ˆ0-10ï¼‰
  const playability_score = calculatePlayabilityScore({
    range_ok,
    leap_mean,
    chromatic_density,
    tempo_qpm,
  });

  // å­¦ç¿’ä¾¡å€¤ã‚¹ã‚³ã‚¢ï¼ˆ0-10ï¼‰
  const learning_value_score = calculateLearningValueScore({
    playability_score,
    repetition_ratio,
    difficulty_delta,
  });

  return {
    learning_value_score,
    playability_score,
    range_ok,
    leap_mean,
    chromatic_density,
    repetition_ratio,
    tempo_qpm,
    difficulty_delta,
  };
}

function calculatePlayabilityScore(params: {
  range_ok: boolean;
  leap_mean: number;
  chromatic_density: number;
  tempo_qpm: number;
}): number {
  let score = 10;

  if (!params.range_ok) score -= 5;              // éŸ³åŸŸå¤–ã¯è‡´å‘½çš„
  if (params.leap_mean > 7) score -= 2;          // è·³èºãŒå¤§ãã™ãã‚‹
  if (params.chromatic_density > 0.5) score -= 1.5; // åŠéŸ³éšãŒå¤šã™ãã‚‹
  if (params.tempo_qpm > 180) score -= 1;        // ãƒ†ãƒ³ãƒãŒé€Ÿã™ãã‚‹

  return Math.max(0, score);
}

function calculateLearningValueScore(params: {
  playability_score: number;
  repetition_ratio: number;
  difficulty_delta: number;
}): number {
  let score = params.playability_score;

  // åå¾©ãŒé©åº¦ã«ã‚ã‚‹ï¼ˆè¨˜æ†¶å®šç€ã«æœ‰åˆ©ï¼‰
  if (params.repetition_ratio >= 0.3 && params.repetition_ratio <= 0.6) {
    score += 1;
  }

  // é›£æ˜“åº¦ãŒ1æ®µéšä¸Šæ˜‡ï¼ˆå­¦ç¿’æ›²ç·šã«æ²¿ã£ã¦ã„ã‚‹ï¼‰
  if (params.difficulty_delta >= 0.8 && params.difficulty_delta <= 1.5) {
    score += 1;
  } else if (params.difficulty_delta > 2.0) {
    score -= 2; // é›£æ˜“åº¦ã‚¸ãƒ£ãƒ³ãƒ—ãŒå¤§ãã™ãã‚‹
  }

  return Math.min(10, Math.max(0, score));
}
```

### 1.3 å“è³ªã‚²ãƒ¼ãƒˆï¼ˆQuality Gateï¼‰

```typescript
// app/api/ai/materials/route.ts
export async function POST(req: NextRequest) {
  // ... AIç”Ÿæˆå‡¦ç† ...

  const abcBlocks = extractAbcBlocks(generatedContent);

  // æ§‹æ–‡æ¤œè¨¼
  const syntaxErrors = abcBlocks
    .map(block => validateAbcSyntax(block.abc))
    .filter(err => err !== null);

  if (syntaxErrors.length > 0) {
    return NextResponse.json({
      success: false,
      error: 'ABCè¨˜æ³•ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼',
      details: syntaxErrors
    }, { status: 400 });
  }

  // å­¦ç¿’ä¾¡å€¤åˆ†æï¼ˆæ–°è¦ï¼‰
  const analysis = analyzeAbc(
    abcBlocks[0].abc,
    body.instrument,
    previousMaterialAnalysis
  );

  // å“è³ªã‚²ãƒ¼ãƒˆåˆ¤å®š
  const QUALITY_THRESHOLD = 6.0;
  const review_status = analysis.learning_value_score >= QUALITY_THRESHOLD
    ? 'approved'
    : 'draft'; // é–¾å€¤æœªæº€ã¯ä¸‹æ›¸ãå›ºå®š

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
  const material = await db.aiMaterials.create({
    data: {
      // ... existing fields ...
      notation: JSON.stringify(abcBlocks),
      quality: {
        ...analysis,
        validation_passed: true,
        review_status,
      },
      metadata: {
        // ... existing metadata ...
        abcNotationBlocks: abcBlocks,
      },
    },
  });

  return NextResponse.json({
    success: true,
    materialId: material.id,
    quality: analysis,
    needsReview: review_status === 'draft',
  });
}
```

---

## 2. æŠ€è¡“çš„å …ç‰¢æ€§

### 2.1 éŸ³ã¾ã‚ã‚Šï¼ˆç«¶åˆå›é¿ã¨ç¢ºå®Ÿå†ç”Ÿï¼‰

#### Web Audio ã®å˜ä¸€è²¬ä»»åŒ–

```typescript
// lib/audio/abc-player.ts
import abcjs from 'abcjs';

class AbcAudioPlayer {
  private synth: any = null;
  private isPlaying: boolean = false;
  private audioContext: AudioContext | null = null;

  async init(abc: string) {
    // Safariå¯¾ç­–: ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®è§£éŒ 
    if (!this.audioContext) {
      this.audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
    }

    if (this.audioContext.state === 'suspended') {
      await this.audioContext.resume();
    }

    try {
      const visualObj = abcjs.renderAbc('hidden-render', abc)[0];

      this.synth = new abcjs.synth.CreateSynth();
      await this.synth.init({
        audioContext: this.audioContext,
        visualObj: visualObj,
      });

      return { success: true };
    } catch (error) {
      console.error('Audio init failed:', error);
      return { success: false, error: error.message };
    }
  }

  async play() {
    if (!this.synth) {
      throw new Error('Audio not initialized');
    }

    try {
      await this.synth.prime();
      this.isPlaying = true;
      this.synth.start();
    } catch (error) {
      console.error('Playback failed:', error);
      this.isPlaying = false;
      throw error;
    }
  }

  pause() {
    if (this.synth && this.isPlaying) {
      this.synth.pause();
      this.isPlaying = false;
    }
  }

  stop() {
    if (this.synth) {
      this.synth.stop();
      this.isPlaying = false;
    }
  }
}

export const audioPlayer = new AbcAudioPlayer();
```

#### ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥

```typescript
// components/features/abc-notation-block.tsx
const handlePlayMidi = async () => {
  try {
    await audioPlayer.init(abc);
    await audioPlayer.play();
  } catch (error) {
    // å†ç”Ÿå¤±æ•—æ™‚ã¯å³åº§ã«MIDIãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’æç¤º
    console.error('Audio playback failed, offering MIDI download:', error);
    setShowFallbackDownload(true);
  }
};

{showFallbackDownload && (
  <div className="bg-yellow-50 border border-yellow-200 rounded p-3 mt-2">
    <p className="text-sm text-yellow-800 mb-2">
      ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚MIDIãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å¤–éƒ¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å†ç”Ÿã§ãã¾ã™ã€‚
    </p>
    <button
      onClick={() => exportAbcToMidi(abc, title)}
      className="text-sm bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700"
    >
      ğŸ“¥ MIDIãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    </button>
  </div>
)}
```

### 2.2 è­œé¢ã¨PDFï¼ˆå°åˆ·å“è³ªã®æ‹…ä¿ï¼‰

#### ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹PDFç”Ÿæˆ

```typescript
// app/api/export/pdf/route.ts
import { NextRequest, NextResponse } from 'next/server';
import puppeteer from 'puppeteer';

export async function POST(req: NextRequest) {
  const { materialId } = await req.json();

  // æ•™æãƒ‡ãƒ¼ã‚¿å–å¾—
  const material = await db.aiMaterials.findUnique({
    where: { id: materialId },
  });

  if (!material) {
    return NextResponse.json({ error: 'Material not found' }, { status: 404 });
  }

  // SSRã§å°åˆ·ç”¨HTMLã‚’ç”Ÿæˆ
  const html = await renderMaterialToHtml(material);

  // Puppeteerã§ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•
  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox'],
  });

  const page = await browser.newPage();
  await page.setContent(html, { waitUntil: 'networkidle0' });

  // å°åˆ·ç”¨CSSã‚’é©ç”¨ã—ã¦PDFç”Ÿæˆ
  const pdfBuffer = await page.pdf({
    format: 'A4',
    printBackground: true,
    margin: {
      top: '20mm',
      right: '15mm',
      bottom: '20mm',
      left: '15mm',
    },
  });

  await browser.close();

  return new NextResponse(pdfBuffer, {
    headers: {
      'Content-Type': 'application/pdf',
      'Content-Disposition': `attachment; filename="${material.title}.pdf"`,
    },
  });
}

async function renderMaterialToHtml(material: AiMaterial): Promise<string> {
  const abcBlocks = JSON.parse(material.notation || '[]');

  // ABCè¨˜æ³•ã‚’SVGã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  const notationSvgs = abcBlocks.map((block: AbcBlock) =>
    abcjs.renderAbc('temp-container', block.abc, {
      responsive: 'resize',
      staffwidth: 600,
    })[0].svg
  );

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        @page {
          size: A4;
          margin: 20mm 15mm;
        }
        body {
          font-family: 'Helvetica', 'Arial', sans-serif;
          line-height: 1.6;
        }
        .header {
          margin-bottom: 20px;
          border-bottom: 2px solid #333;
          padding-bottom: 10px;
        }
        .title {
          font-size: 24px;
          font-weight: bold;
        }
        .subtitle {
          font-size: 12px;
          color: #666;
          margin-top: 5px;
        }
        .content {
          margin: 20px 0;
        }
        .notation-block {
          margin: 30px 0;
          page-break-inside: avoid;
        }
        .notation-title {
          font-size: 16px;
          font-weight: bold;
          margin-bottom: 10px;
        }
      </style>
    </head>
    <body>
      <div class="header">
        <div class="title">${material.title}</div>
        <div class="subtitle">
          ${material.metadata?.instrument} | ${material.metadata?.difficulty} | ${material.metadata?.duration}åˆ†
        </div>
      </div>

      <div class="content">
        ${markdownToHtml(material.content)}
      </div>

      ${notationSvgs.map((svg: string, idx: number) => `
        <div class="notation-block">
          <div class="notation-title">${abcBlocks[idx].title}</div>
          ${svg}
        </div>
      `).join('')}

      <div class="footer">
        <p style="text-align: center; font-size: 10px; color: #999;">
          Generated with MUED LMS | ${new Date().toLocaleDateString()}
        </p>
      </div>
    </body>
    </html>
  `;
}
```

### 2.3 MusicXML ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆéåŒæœŸå‡¦ç†ï¼‰

```typescript
// app/api/export/musicxml/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { Queue } from 'bull';

const exportQueue = new Queue('musicxml-export', {
  redis: { host: 'localhost', port: 6379 },
});

export async function POST(req: NextRequest) {
  const { materialId } = await req.json();

  // ã‚­ãƒ¥ãƒ¼ã«æŠ•å…¥
  const job = await exportQueue.add({
    materialId,
    userId: req.userId,
    timestamp: Date.now(),
  });

  return NextResponse.json({
    success: true,
    jobId: job.id,
    message: 'MusicXMLå¤‰æ›ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚å®Œäº†æ™‚ã«é€šçŸ¥ã—ã¾ã™ã€‚',
  });
}

// Workerï¼ˆåˆ¥ãƒ—ãƒ­ã‚»ã‚¹ï¼‰
exportQueue.process(async (job) => {
  const { materialId } = job.data;

  const material = await db.aiMaterials.findUnique({
    where: { id: materialId },
  });

  const abcBlocks = JSON.parse(material.notation || '[]');

  // abc2xmlã§å¤‰æ›
  const musicXmlFiles = await Promise.all(
    abcBlocks.map(async (block: AbcBlock) => {
      const tempAbcPath = `/tmp/${Date.now()}_${block.id}.abc`;
      const outputPath = `/tmp/${Date.now()}_${block.id}.xml`;

      await fs.promises.writeFile(tempAbcPath, block.abc);
      await execAsync(`abc2xml ${tempAbcPath} -o ${outputPath}`);

      return {
        title: block.title,
        path: outputPath,
      };
    })
  );

  // S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦é€šçŸ¥
  const urls = await uploadFilesToS3(musicXmlFiles);

  await notifyUserExportComplete(job.data.userId, {
    materialId,
    urls,
  });

  return { success: true, urls };
});
```

---

## 3. å¸‚å ´æ•´åˆæ€§ï¼šä½¿ã†äººãƒ»ä½¿ã†ç¬é–“

### 3.1 3ã¤ã®ä¸»è¦ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

#### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹1: å…ˆç”Ÿã®ã€Œ5åˆ†å‰å°ãƒ†ã‚¹ãƒˆã€è‡ªå‹•åŒ–

**ã‚·ãƒŠãƒªã‚ª:**
æˆæ¥­é–‹å§‹5åˆ†å‰ã€å‰å›æˆæ¥­ã®ç”Ÿå¾’ã®è‹¦æ‰‹ç®‡æ‰€ã‹ã‚‰8å°ç¯€ã®å°ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã€å³å°åˆ·ã€‚

**å®Ÿè£…:**

```typescript
// app/api/ai/quick-test/route.ts
export async function POST(req: NextRequest) {
  const { classId, previousLessonId } = await req.json();

  // ã‚¯ãƒ©ã‚¹ã®è‹¦æ‰‹ç®‡æ‰€ã‚’é›†è¨ˆ
  const weakPoints = await db.learningMetrics.findMany({
    where: {
      material_id: previousLessonId,
      user_id: { in: getClassStudents(classId) },
    },
    select: {
      loop_sections: true,
    },
  });

  // æœ€ã‚‚å¤šãã®ç”Ÿå¾’ãŒè‹¦æ‰‹ã¨ã™ã‚‹å°ç¯€ã‚’ç‰¹å®š
  const commonWeakBars = analyzeCommonWeakPoints(weakPoints);

  // åŒç­‰ã®é›£æ˜“åº¦ã§8å°ç¯€ã®ç·´ç¿’å•é¡Œã‚’ç”Ÿæˆ
  const testPrompt = `
    ä»¥ä¸‹ã®è‹¦æ‰‹ç®‡æ‰€ã‚’è¸ã¾ãˆã¦ã€8å°ç¯€ã®ç·´ç¿’å•é¡Œã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:
    - é »å‡ºè‹¦æ‰‹å°ç¯€: ${commonWeakBars.join(', ')}
    - æ¥½å™¨: ${classInstrument}
    - ãƒ¬ãƒ™ãƒ«: ${classLevel}

    è¦ä»¶:
    - åŒç­‰ã®é›£æ˜“åº¦ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³
    - ABCè¨˜æ³•ã§è­œé¢ä»˜ã
    - 1ãƒšãƒ¼ã‚¸ã«åã¾ã‚‹åˆ†é‡
  `;

  const material = await generateMaterial(testPrompt);

  // å³åº§ã«PDFç”Ÿæˆ
  const pdfUrl = await generatePdfInBackground(material.id);

  return NextResponse.json({
    success: true,
    materialId: material.id,
    pdfUrl,
    weakPoints: commonWeakBars,
  });
}
```

**UI:**

```tsx
// app/dashboard/teacher/quick-test/page.tsx
export default function QuickTestPage() {
  const [generating, setGenerating] = useState(false);

  const handleGenerate = async () => {
    setGenerating(true);
    const result = await fetch('/api/ai/quick-test', {
      method: 'POST',
      body: JSON.stringify({ classId, previousLessonId }),
    }).then(r => r.json());

    // å³åº§ã«PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    window.open(result.pdfUrl, '_blank');
    setGenerating(false);
  };

  return (
    <div className="max-w-2xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-4">ğŸ¯ æˆæ¥­å‰å°ãƒ†ã‚¹ãƒˆç”Ÿæˆ</h1>
      <p className="text-gray-600 mb-6">
        å‰å›æˆæ¥­ã®è‹¦æ‰‹ç®‡æ‰€ã‹ã‚‰8å°ç¯€ã®ç·´ç¿’å•é¡Œã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚
      </p>

      <button
        onClick={handleGenerate}
        disabled={generating}
        className="w-full py-3 bg-green-600 text-white rounded hover:bg-green-700"
      >
        {generating ? 'ç”Ÿæˆä¸­...' : 'ğŸ“ å°ãƒ†ã‚¹ãƒˆã‚’ä»Šã™ãä½œæˆ'}
      </button>
    </div>
  );
}
```

#### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹2: å€‹äººã®ã€Œè‹¦æ‰‹ãƒ‰ãƒªãƒ«ã€1ã‚¯ãƒªãƒƒã‚¯

**ã‚·ãƒŠãƒªã‚ª:**
ç·´ç¿’ä¸­ã«ãƒ«ãƒ¼ãƒ—ã—ãŸå°ç¯€ã‹ã‚‰ã€åŒç­‰ãƒ»1æ®µéšä¸Šãƒ»1æ®µéšä¸‹ã®3ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆã€‚

```typescript
// app/api/ai/weak-drill/route.ts
export async function POST(req: NextRequest) {
  const { materialId, loopedBar } = await req.json();

  const material = await db.aiMaterials.findUnique({
    where: { id: materialId },
  });

  const abcBlocks = JSON.parse(material.notation || '[]');
  const targetBar = extractBar(abcBlocks[0].abc, loopedBar);

  // åŒç­‰ãƒ»ä¸Šãƒ»ä¸‹ã®3ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
  const variations = await generateVariations(targetBar, {
    same: { difficulty: 0 },
    up: { difficulty: +1 },
    down: { difficulty: -1 },
  });

  return NextResponse.json({
    success: true,
    variations,
  });
}
```

#### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹3: è¬›ç¾©ãƒãƒ¼ãƒˆâ†’æ•™æåŒ–

**ã‚·ãƒŠãƒªã‚ª:**
Markdownã§æ›¸ã„ãŸç†è«–ãƒãƒ¼ãƒˆã«è­œä¾‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’è‡ªå‹•æŒ¿å…¥ã—ã¦é…å¸ƒPDFç”Ÿæˆã€‚

---

### 3.2 å°å…¥ãƒ•ãƒ­ãƒ¼

#### å…ˆç”Ÿå‘ã‘

1. **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰é–‹å§‹**: å­¦æœŸã‚·ãƒ©ãƒã‚¹é››å½¢ã‚’é¸æŠ
2. **ã‚¯ãƒ©ã‚¹æƒ…å ±ç™»éŒ²**: æ¥½å™¨ãƒ»ãƒ¬ãƒ™ãƒ«ãƒ»ç”Ÿå¾’æ•°
3. **è‡ªå‹•å°ãƒ†ã‚¹ãƒˆ**: æ¯é€±ã®è‹¦æ‰‹ç®‡æ‰€ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ
4. **KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: ã‚¯ãƒ©ã‚¹å…¨ä½“ã®é”æˆç‡ãƒ»ãƒ†ãƒ³ãƒåˆ°é”ã‚’å¯è¦–åŒ–

#### å€‹äººå‘ã‘

1. **æ¥½å™¨ãƒ»ãƒ¬ãƒ™ãƒ«é¸æŠ**: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
2. **ã€Œè‹¦æ‰‹ã‹ã‚‰ä½œã‚‹ã€ãƒœã‚¿ãƒ³**: éå»ã®ãƒ«ãƒ¼ãƒ—å±¥æ­´ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ
3. **3ãƒœã‚¿ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼**: å†ç”Ÿãƒ»é€Ÿåº¦ãƒ»ãƒ«ãƒ¼ãƒ—ã®ã¿

---

## 4. UXã®å‰Šã‚Šè¾¼ã¿ï¼š3ãƒœã‚¿ãƒ³ä¸»ç¾©

### 4.1 ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”»é¢

```tsx
// components/features/material-player.tsx
export function MaterialPlayer({ abc, title }: MaterialPlayerProps) {
  const [speed, setSpeed] = useState(1.0);
  const [loopRange, setLoopRange] = useState<[number, number] | null>(null);
  const [playing, setPlaying] = useState(false);

  return (
    <div className="material-player">
      {/* æ¥½è­œè¡¨ç¤º */}
      <div ref={notationRef} className="notation-display mb-4" />

      {/* 3ãƒœã‚¿ãƒ³ä¸»ç¾© */}
      <div className="controls flex items-center gap-4">
        {/* å†ç”Ÿãƒœã‚¿ãƒ³ */}
        <button
          onClick={() => playing ? pause() : play()}
          className="w-16 h-16 bg-green-600 text-white rounded-full hover:bg-green-700 flex items-center justify-center text-2xl"
        >
          {playing ? 'â¸' : 'â–¶ï¸'}
        </button>

        {/* é€Ÿåº¦ãƒ—ãƒªã‚»ãƒƒãƒˆ */}
        <div className="flex gap-2">
          {[-20, -10, 0, 10].map(offset => (
            <button
              key={offset}
              onClick={() => setSpeed(1 + offset / 100)}
              className={`px-3 py-2 rounded ${
                speed === 1 + offset / 100
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
              }`}
            >
              {offset === 0 ? '100%' : `${offset > 0 ? '+' : ''}${offset}%`}
            </button>
          ))}
        </div>

        {/* ãƒ«ãƒ¼ãƒ—é¸æŠ */}
        <button
          onClick={() => setLoopMode(!loopMode)}
          className={`px-4 py-2 rounded ${
            loopMode ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'
          }`}
        >
          ğŸ” ãƒ«ãƒ¼ãƒ—
        </button>
      </div>

      {/* å‡ºåŠ›ã¯1ã¤ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æ ¼ç´ */}
      <div className="mt-4">
        <details className="border rounded p-2">
          <summary className="cursor-pointer font-medium text-gray-700">
            ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </summary>
          <div className="mt-2 flex flex-col gap-2">
            <button onClick={exportPdf} className="text-left px-3 py-2 hover:bg-gray-100 rounded">
              ğŸ“„ PDFå‡ºåŠ›
            </button>
            <button onClick={exportMidi} className="text-left px-3 py-2 hover:bg-gray-100 rounded">
              ğŸ¹ MIDIå‡ºåŠ›
            </button>
            <button onClick={exportMusicXml} className="text-left px-3 py-2 hover:bg-gray-100 rounded">
              ğŸ¼ MusicXMLå‡ºåŠ›
            </button>
          </div>
        </details>
      </div>

      {/* é€²æ—ãƒªãƒ³ã‚° */}
      <div className="mt-6">
        <ProgressRing
          sections={material.metadata.sections}
          completed={completedSections}
        />
      </div>
    </div>
  );
}
```

### 4.2 ç”Ÿæˆç”»é¢

```tsx
// app/dashboard/materials/new/page.tsxï¼ˆç°¡ç•¥ç‰ˆï¼‰
export default function NewMaterialPage() {
  const [includeNotation, setIncludeNotation] = useState(true); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON

  return (
    <form onSubmit={handleSubmit}>
      {/* æ—¢å­˜ã®ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */}

      {/* ç”Ÿæˆå¾Œã«å­¦ç¿’ä¾¡å€¤ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º */}
      {generatedMaterial && (
        <div className="mt-6 border rounded-lg p-4">
          <h3 className="font-semibold mb-2">ğŸ“Š æ•™æå“è³ªã‚¹ã‚³ã‚¢</h3>
          <div className="flex items-center gap-4">
            <div className="text-3xl font-bold text-green-600">
              {generatedMaterial.quality.learning_value_score.toFixed(1)}
            </div>
            <div className="text-sm text-gray-600">
              / 10.0
            </div>
          </div>

          {generatedMaterial.quality.review_status === 'draft' ? (
            <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded p-3">
              <p className="text-sm text-yellow-800">
                âš ï¸ å­¦ç¿’ä¾¡å€¤ã‚¹ã‚³ã‚¢ãŒåŸºæº–å€¤ï¼ˆ6.0ï¼‰ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ã€‚
                å…¬é–‹å‰ã«å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
              </p>
              <div className="mt-2 flex gap-2">
                <button className="text-sm px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700">
                  å†ç”Ÿæˆ
                </button>
                <button className="text-sm px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700">
                  æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦å…¬é–‹
                </button>
              </div>
            </div>
          ) : (
            <div className="mt-4 bg-green-50 border border-green-200 rounded p-3">
              <p className="text-sm text-green-800">
                âœ… æ•™æã¯å­¦ç¿’ä¾¡å€¤åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™ã€‚
              </p>
              <button className="mt-2 text-sm px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                æ•™æãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«è¿½åŠ 
              </button>
            </div>
          )}
        </div>
      )}
    </form>
  );
}
```

---

## 5. å®Ÿè£…ã‚¿ã‚¹ã‚¯ï¼ˆ6é€±é–“ãƒ—ãƒ©ãƒ³ï¼‰

### Week 1: éŸ³ã¨PDFã®åœŸå°

- [ ] `lib/audio/abc-player.ts` å®Ÿè£…ï¼ˆabcjs.synth çµ±ä¸€ï¼‰
- [ ] Safari/Chrome ã§ã® Web Audio Context è§£éŒ å‡¦ç†
- [ ] å†ç”Ÿå¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆMIDIãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æç¤ºï¼‰
- [ ] `/api/export/pdf` å®Ÿè£…ï¼ˆPuppeteer + å°åˆ·CSSï¼‰
- [ ] SSRã«ã‚ˆã‚‹HTMLç”Ÿæˆã¨ãƒ•ã‚©ãƒ³ãƒˆåŸ‹ã‚è¾¼ã¿ç¢ºèª

### Week 2: åˆ†æã¨ã‚¹ã‚³ã‚¢

- [ ] `lib/abc-analyzer.ts` å®Ÿè£…
  - `analyzeAbc()` - éŸ³åŸŸãƒ»è·³èºãƒ»å¯†åº¦ãƒ»åå¾©ã®çµ±è¨ˆ
  - `calculatePlayabilityScore()` - æ¼”å¥å¯èƒ½æ€§ã‚¹ã‚³ã‚¢
  - `calculateLearningValueScore()` - å­¦ç¿’ä¾¡å€¤ã‚¹ã‚³ã‚¢
- [ ] `quality` åˆ—ã‚’DBã«è¿½åŠ 
- [ ] å“è³ªã‚²ãƒ¼ãƒˆå®Ÿè£…ï¼ˆã‚¹ã‚³ã‚¢ < 6.0 ã¯ä¸‹æ›¸ãå›ºå®šï¼‰

### Week 3: KPIãƒ­ã‚°

- [ ] `learning_metrics` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] é”æˆç‡ãƒ»åå¾©ãƒ»ãƒ†ãƒ³ãƒåˆ°é”ãƒ»ãƒ«ãƒ¼ãƒ—å°ç¯€ã®è¨ˆæ¸¬
- [ ] ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¨ˆæ¸¬ã‚³ãƒ¼ãƒ‰ã‚’åŸ‹ã‚è¾¼ã¿
- [ ] å€‹äººãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆé€²æ—ãƒªãƒ³ã‚°ï¼‰
- [ ] å…ˆç”Ÿå‘ã‘ã‚¯ãƒ©ã‚¹é›†è¨ˆãƒ“ãƒ¥ãƒ¼

### Week 4: å…ˆç”Ÿå‘ã‘ã€Œ5åˆ†å‰å°ãƒ†ã‚¹ãƒˆã€

- [ ] `/api/ai/quick-test` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
- [ ] è‹¦æ‰‹ç®‡æ‰€ã®é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯
- [ ] 8å°ç¯€ç·´ç¿’å•é¡Œã®è‡ªå‹•ç”Ÿæˆ
- [ ] å³åº§ã«PDFå‡ºåŠ›
- [ ] UI: `app/dashboard/teacher/quick-test/page.tsx`

### Week 5: å€‹äººã®ã€Œè‹¦æ‰‹ãƒ‰ãƒªãƒ«ã€

- [ ] `/api/ai/weak-drill` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
- [ ] ãƒ«ãƒ¼ãƒ—é¸æŠã‹ã‚‰ã®ç­‰ä¾¡ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼ˆåŒé›£åº¦ãƒ»+1ãƒ»-1ï¼‰
- [ ] UI: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å†…ã«ã€Œè‹¦æ‰‹ãƒ‰ãƒªãƒ«ç”Ÿæˆã€ãƒœã‚¿ãƒ³è¿½åŠ 

### Week 6: A/Bã¨å“è³ªã‚²ãƒ¼ãƒˆ

- [ ] åŒä¸€ãƒ†ãƒ¼ãƒã®æ•™æã‚’A/Bé…ä¿¡
- [ ] é”æˆç‡ãƒ»ãƒ†ãƒ³ãƒåˆ°é”ã§è‡ªå‹•å‹è€…é¸å®š
- [ ] Quality Gate æœªé€šéæ•™æã®è‡ªå‹•éè¡¨ç¤º
- [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ç›£æŸ»ï¼ˆWCAG 2.1 AAæº–æ‹ ï¼‰
- [ ] E2Eãƒ†ã‚¹ãƒˆï¼ˆPlaywrightï¼‰

---

## 6. å¤±æ•—ã—ãªã„ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«

### AIãƒ¢ãƒ‡ãƒ«åˆ¶å¾¡

```typescript
// lib/ai/prompt-templates.ts
const ABC_STRICT_TEMPLATE = `
ä»¥ä¸‹ã®å³æ ¼ãªãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ABCè¨˜æ³•ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:

å¿…é ˆãƒ˜ãƒƒãƒ€ãƒ¼:
X:1
T:{{title}}
M:{{meter}}
L:{{note_length}}
Q:{{tempo}}
K:{{key}}

éŸ³åŸŸåˆ¶é™: {{instrument_range}}
æœ€å¤§è·³èº: {{max_leap}} åŠéŸ³
ãƒ†ãƒ³ãƒç¯„å›²: {{tempo_min}}-{{tempo_max}} BPM
å°ç¯€æ•°: {{bar_count}}

é€¸è„±ã—ãŸå ´åˆã¯è‡ªå‹•ã§å†ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
`;

export function generateAbcPrompt(params: AbcGenerationParams): string {
  const instrumentRange = INSTRUMENT_RANGES[params.instrument];

  return ABC_STRICT_TEMPLATE
    .replace('{{title}}', params.title)
    .replace('{{meter}}', params.meter)
    .replace('{{note_length}}', params.noteLength)
    .replace('{{tempo}}', params.tempo.toString())
    .replace('{{key}}', params.key)
    .replace('{{instrument_range}}', instrumentRange)
    .replace('{{max_leap}}', params.maxLeap.toString())
    .replace('{{tempo_min}}', params.tempoMin.toString())
    .replace('{{tempo_max}}', params.tempoMax.toString())
    .replace('{{bar_count}}', params.barCount.toString());
}
```

### ã‚³ã‚¹ãƒˆä¸Šé™ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒˆãƒªãƒƒã‚¯å¤‰å½¢ï¼‰

```typescript
// lib/ai/parametric-transform.ts
/**
 * å­¦ç¿’ãƒ«ãƒ¼ãƒ—ã§ã¯å†ç”Ÿæˆã›ãšã€æ—¢å­˜æ•™æã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¤‰å½¢
 */
export function transformAbc(
  abc: string,
  transformation: 'transpose' | 'rhythmVariation' | 'startNote'
): string {
  const parsed = parseAbc(abc);

  switch (transformation) {
    case 'transpose':
      // èª¿ã‚’Â±2ã¾ã§ç§»èª¿
      return transposeAbc(parsed, randomInt(-2, 2));

    case 'rhythmVariation':
      // ãƒªã‚ºãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åŒç­‰é›£æ˜“åº¦ã§ç½®æ›
      return replaceRhythmPattern(parsed);

    case 'startNote':
      // é–‹å§‹éŸ³ã‚’å¤‰æ›´ï¼ˆéŸ³åŸŸå†…ã§ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
      return changeStartNote(parsed);
  }
}
```

### è€éšœå®³ï¼ˆOpenAI ãƒ€ã‚¦ãƒ³æ™‚ï¼‰

```typescript
// app/api/ai/materials/route.ts
export async function POST(req: NextRequest) {
  try {
    // OpenAI APIå‘¼ã³å‡ºã—
    const response = await openai.chat.completions.create({
      // ...
    });

    return await processMaterial(response);
  } catch (error) {
    if (error.code === 'ECONNREFUSED' || error.status === 503) {
      // OpenAI ãƒ€ã‚¦ãƒ³æ™‚ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‹å¤‰å½¢ã§ãƒ­ãƒ¼ã‚«ãƒ«ç”Ÿæˆ
      console.warn('OpenAI unavailable, falling back to template generation');

      const templateMaterial = selectTemplate(req.body.materialType);
      const transformed = transformAbc(templateMaterial.abc, 'transpose');

      return NextResponse.json({
        success: true,
        materialId: await saveMaterial(transformed),
        fallbackMode: true,
        message: 'AIä¸€æ™‚åœæ­¢ä¸­ã®ãŸã‚ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ç”Ÿæˆã—ã¾ã—ãŸ',
      });
    }

    throw error;
  }
}
```

---

## 7. æˆåŠŸæŒ‡æ¨™

### ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆå“è³ªåŸºæº–

| æŒ‡æ¨™ | ç›®æ¨™å€¤ | è¨ˆæ¸¬æ–¹æ³• |
|-----|--------|---------|
| æ¥½è­œã®æ­£ç¢ºæ€§ | ABCæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ç‡ < 5% | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéç‡ |
| å­¦ç¿’ä¾¡å€¤ | å¹³å‡ã‚¹ã‚³ã‚¢ > 7.0 | analyzeAbc() ã®å¹³å‡ |
| ç”Ÿæˆé€Ÿåº¦ | < 30ç§’ï¼ˆæ¥½è­œå«ã‚€ï¼‰ | APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  |
| ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå“è³ª | PDF/MIDIå‡ºåŠ›æˆåŠŸç‡ > 95% | ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ­ã‚° |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ | æ¥½è­œä»˜ãæ•™æã®è©•ä¾¡ > 4.0/5.0 | ã‚¢ãƒ—ãƒªå†…ãƒ¬ãƒ“ãƒ¥ãƒ¼ |

### ãƒ“ã‚¸ãƒã‚¹æŒ‡æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¤ | è¨ˆæ¸¬æ–¹æ³• |
|-----|--------|---------|
| æ•™æç”Ÿæˆæ•° | æœˆé–“100ä»¶ä»¥ä¸Š | DBé›†è¨ˆ |
| ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆåˆ©ç”¨ç‡ | ç”Ÿæˆæ•™æã®30%ä»¥ä¸Š | ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œç‡ |
| ãƒªãƒ”ãƒ¼ãƒˆç‡ | 60%ãŒ2é€±é–“ä»¥å†…ã«å†åˆ©ç”¨ | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ãƒ­ã‚° |
| é”æˆç‡ | ã‚¯ãƒ©ã‚¹å¹³å‡ > 70% | learning_metrics é›†è¨ˆ |
| ãƒ†ãƒ³ãƒåˆ°é”ç‡ | > 80% | é€Ÿåº¦è¨­å®šå±¥æ­´ |

### æ•™è‚²åŠ¹æœæŒ‡æ¨™ï¼ˆæœ€é‡è¦ï¼‰

| æŒ‡æ¨™ | ç›®æ¨™å€¤ | è¨ˆæ¸¬æ–¹æ³• |
|-----|--------|---------|
| è‹¦æ‰‹ç®‡æ‰€ã®æ”¹å–„ | åå¾©å¾Œã®é”æˆç‡ +20%ä»¥ä¸Š | å‰å¾Œæ¯”è¼ƒ |
| ç¶™ç¶šå­¦ç¿’æ—¥æ•° | å¹³å‡14æ—¥ä»¥ä¸Š/æœˆ | ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ |
| å…ˆç”Ÿã®æº–å‚™æ™‚é–“å‰Šæ¸› | 50%å‰Šæ¸›ï¼ˆå°ãƒ†ã‚¹ãƒˆç”Ÿæˆï¼‰ | ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ |

---

## 8. å°†æ¥æ‹¡å¼µï¼ˆãƒ•ã‚§ãƒ¼ã‚º2ä»¥é™ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º2: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ©Ÿèƒ½ï¼ˆ3ãƒ¶æœˆå¾Œï¼‰

- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ MIDIå…¥åŠ›å¯¾å¿œï¼ˆæ¼”å¥ã®è¨˜éŒ²ï¼‰
- [ ] æ¥½è­œã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼ˆæŒ‡ä½¿ã„ãƒ»æ³¨é‡ˆè¿½åŠ ï¼‰
- [ ] ç·´ç¿’ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²ãƒ»çµ±è¨ˆï¼‰
- [ ] å”èª¿ç·¨é›†ï¼ˆè¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§æ¥½è­œå…±æœ‰ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º3: é«˜åº¦ãªAIæ©Ÿèƒ½ï¼ˆ6ãƒ¶æœˆå¾Œï¼‰

- [ ] æ¼”å¥éŸ³å£°ã®è‡ªå‹•æ¡è­œï¼ˆAudio â†’ ABCï¼‰
- [ ] AIã«ã‚ˆã‚‹æ¼”å¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆéŸ³ç¨‹ãƒ»ãƒªã‚ºãƒ åˆ†æï¼‰
- [ ] ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸç·´ç¿’ãƒ—ãƒ©ãƒ³ç”Ÿæˆ
- [ ] è€³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¢ãƒ—ãƒªï¼ˆWeb Audio APIï¼‰

---

## ã¾ã¨ã‚

### ãƒ•ã‚§ãƒ¼ã‚º1ï¼ˆV3.0ï¼‰ã®æœ¬è³ª

**ã€ŒAIãŒæ•™æã‚’ä½œã‚‹ã€ã§ã¯ãªãã€ŒAIãŒå­¦ç¿’ã‚’å‰ã«é€²ã‚ã‚‹ã€**

1. **å­¦ç¿’åŠ¹æœã‚’æ¸¬ã‚‹** - é”æˆç‡ãƒ»åå¾©ãƒ»ãƒ†ãƒ³ãƒåˆ°é”ãƒ»è‹¦æ‰‹æ¤œå‡º
2. **æ•™æã®ä¾¡å€¤ã‚’ä¿è¨¼ã™ã‚‹** - å­¦ç¿’ä¾¡å€¤ã‚¹ã‚³ã‚¢ãƒ»å“è³ªã‚²ãƒ¼ãƒˆ
3. **ç¢ºå®Ÿã«å‹•ã** - éŸ³å†ç”Ÿã®å …ç‰¢æ€§ãƒ»å°åˆ·å“è³ªã®æ‹…ä¿
4. **ä½¿ã„ã‚„ã™ã•ã®å¾¹åº•** - 3ãƒœã‚¿ãƒ³ä¸»ç¾©ãƒ»èªçŸ¥è² è·ã®æœ€å°åŒ–
5. **å®Ÿå‹™ã«åˆºã•ã‚‹** - å…ˆç”Ÿã®5åˆ†å‰å°ãƒ†ã‚¹ãƒˆãƒ»å€‹äººã®è‹¦æ‰‹ãƒ‰ãƒªãƒ«

### æŠ€è¡“çš„ãƒã‚¤ãƒ©ã‚¤ãƒˆ

- **ABCè¨˜æ³• + å­¦ç¿’ä¾¡å€¤åˆ†æ** ã§æ•™è‚²çš„è²¬ä»»ã‚’æ‹…ä¿
- **abcjs + Puppeteer** ã§ç¢ºå®Ÿãªæ¥½è­œè¡¨ç¤ºãƒ»PDFç”Ÿæˆ
- **å­¦ç¿’ãƒ¡ãƒˆãƒªã‚¯ã‚¹** ã§ç¶™ç¶šçš„æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«
- **3ãƒœã‚¿ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼** ã§å­¦ç¿’ä½“é¨“ã«é›†ä¸­

### æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼

**Week 3çµ‚äº†æ™‚**ï¼ˆKPIãƒ­ã‚°å®Ÿè£…å®Œäº†å¾Œï¼‰
- å­¦ç¿’ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨ˆæ¸¬ç²¾åº¦ç¢ºèª
- å…ˆç”Ÿãƒ»å€‹äººãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†
- å“è³ªã‚²ãƒ¼ãƒˆã®é–¾å€¤èª¿æ•´

---

## 9. é‹ç”¨ã§æ‰ã‚ã‚‹ãƒã‚¤ãƒ³ãƒˆã¨å¯¾ç­–ï¼ˆå®Ÿè£…å‰ã®èµ¤å…¥ã‚Œï¼‰

### 9.1 å­¦ç¿’KPIã®å¦¥å½“æ€§æ‹…ä¿

#### æ¥½å™¨åˆ¥ã®åˆ°é”ä¿‚æ•°

åŒã˜BPMåˆ°é”ã§ã‚‚æ¥½å™¨ã”ã¨ã®è² è·ãŒç•°ãªã‚Šã¾ã™ã€‚

```typescript
// lib/metrics/instrument-coefficients.ts
const INSTRUMENT_DIFFICULTY_COEFFICIENTS = {
  // éµç›¤æ¥½å™¨ï¼ˆè¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¼·ã€ç‰©ç†çš„è² è·ä¸­ï¼‰
  piano: { tempo_coefficient: 1.0, leap_coefficient: 1.0 },
  keyboard: { tempo_coefficient: 1.0, leap_coefficient: 1.0 },

  // å¼¦æ¥½å™¨ï¼ˆé‹æŒ‡è¤‡é›‘ã€ãƒã‚¸ã‚·ãƒ§ãƒ³ç§»å‹•è² è·é«˜ï¼‰
  guitar: { tempo_coefficient: 1.2, leap_coefficient: 1.3 },
  bass: { tempo_coefficient: 1.1, leap_coefficient: 1.2 },
  violin: { tempo_coefficient: 1.3, leap_coefficient: 1.4 },

  // ç®¡æ¥½å™¨ï¼ˆå‘¼å¸ç®¡ç†ã€éŸ³ç¨‹åˆ¶å¾¡é«˜è² è·ï¼‰
  trumpet: { tempo_coefficient: 1.4, leap_coefficient: 1.5 },
  saxophone: { tempo_coefficient: 1.3, leap_coefficient: 1.4 },
  flute: { tempo_coefficient: 1.2, leap_coefficient: 1.3 },

  // æ‰“æ¥½å™¨ï¼ˆãƒªã‚ºãƒ ç²¾åº¦ç‰¹åŒ–ï¼‰
  drums: { tempo_coefficient: 1.5, leap_coefficient: 0.5 },
};

export function calculateAdjustedTempo(
  achievedTempo: number,
  targetTempo: number,
  instrument: string
): number {
  const coefficient = INSTRUMENT_DIFFICULTY_COEFFICIENTS[instrument]?.tempo_coefficient || 1.0;

  // ä¿‚æ•°é©ç”¨å¾Œã®åˆ°é”ç‡
  const adjustedRate = (achievedTempo / targetTempo) * coefficient;

  return Math.min(100, adjustedRate * 100);
}
```

#### å°†æ¥æ‹¡å¼µç”¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç¢ºä¿

```sql
-- learning_metrics ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
ALTER TABLE learning_metrics
  ADD COLUMN rhythm_entropy FLOAT,           -- ãƒªã‚ºãƒ ã®è¦å‰‡æ€§ï¼ˆä½ã„ã»ã©è¦å‰‡çš„ï¼‰
  ADD COLUMN downbeat_landing_rate FLOAT,    -- æ‹é ­ã¸ã®ç€åœ°ç‡ï¼ˆ0-1ï¼‰
  ADD COLUMN fingering_hint_present BOOLEAN, -- é‹æŒ‡ãƒ’ãƒ³ãƒˆã®æœ‰ç„¡
  ADD COLUMN articulation_quality FLOAT;     -- ã‚¢ãƒ¼ãƒ†ã‚£ã‚­ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å“è³ªï¼ˆå°†æ¥ï¼‰
```

### 9.2 å“è³ªã‚²ãƒ¼ãƒˆã®å‹•çš„èª¿æ•´

å›ºå®šé–¾å€¤ï¼ˆ6.0ï¼‰ã¯æš«å®šå€¤ã€‚ã‚³ãƒ›ãƒ¼ãƒˆå·®ã§æœ€é©å€¤ãŒã‚ºãƒ¬ã‚‹ãŸã‚ã€é€±æ¬¡ã§è‡ªå‹•èª¿æ•´ã€‚

```typescript
// lib/quality/adaptive-threshold.ts
interface ThresholdHistory {
  week: string;
  threshold: number;
  pass_rate: number;
  avg_score: number;
  user_satisfaction: number;
}

export async function updateQualityThreshold(): Promise<number> {
  // éå»4é€±é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const history = await db.query(`
    SELECT
      DATE_TRUNC('week', created_at) as week,
      AVG(quality->>'learning_value_score') as avg_score,
      COUNT(CASE WHEN quality->>'review_status' = 'approved' THEN 1 END) / COUNT(*)::float as pass_rate,
      AVG(user_ratings.score) as user_satisfaction
    FROM ai_materials
    LEFT JOIN user_ratings ON ai_materials.id = user_ratings.material_id
    WHERE created_at > NOW() - INTERVAL '4 weeks'
    GROUP BY week
    ORDER BY week DESC
  `);

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ãŒ4.0ä»¥ä¸Šã‚’ç¶­æŒã™ã‚‹é–¾å€¤ã‚’æ¢ç´¢
  const TARGET_SATISFACTION = 4.0;
  const currentSatisfaction = history[0].user_satisfaction;

  let newThreshold = 6.0; // åˆæœŸå€¤

  if (currentSatisfaction < TARGET_SATISFACTION) {
    // æº€è¶³åº¦ä½ä¸‹ â†’ é–¾å€¤ã‚’ä¸Šã’ã¦å“è³ªé‡è¦–
    newThreshold = Math.min(8.0, history[0].threshold + 0.5);
  } else if (currentSatisfaction > TARGET_SATISFACTION + 0.5) {
    // æº€è¶³åº¦é«˜ã™ãã‚‹ â†’ é–¾å€¤ã‚’ä¸‹ã’ã¦ç”Ÿæˆé‡å¢—åŠ 
    newThreshold = Math.max(5.0, history[0].threshold - 0.3);
  }

  // è¨­å®šã‚’æ›´æ–°
  await db.settings.upsert({
    where: { key: 'quality_threshold' },
    update: { value: newThreshold, updated_at: new Date() },
  });

  return newThreshold;
}

// é€±æ¬¡ã§å®Ÿè¡Œï¼ˆcron jobï¼‰
// 0 0 * * 0 node scripts/update-quality-threshold.js
```

### 9.3 PDFç”Ÿæˆã®å¯æ¬æ€§ã¨å³æ™‚æ€§

#### ãƒ•ã‚©ãƒ³ãƒˆåŸ‹ã‚è¾¼ã¿ã®ç¢ºå®ŸåŒ–

```typescript
// lib/export/pdf-fonts.ts
const NOTATION_FONTS = `
  @font-face {
    font-family: 'Bravura';
    src: url('data:font/woff2;base64,${BRAVURA_BASE64}') format('woff2');
    font-weight: normal;
    font-style: normal;
  }
  @font-face {
    font-family: 'Academico';
    src: url('data:font/woff2;base64,${ACADEMICO_BASE64}') format('woff2');
    font-weight: normal;
    font-style: normal;
  }
`;

// Puppeteer PDFç”Ÿæˆæ™‚ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŸ‹ã‚è¾¼ã¿
const pdfStyles = `
  <style>
    ${NOTATION_FONTS}

    body {
      font-family: 'Academico', 'Helvetica', 'Arial', sans-serif;
    }

    .notation {
      font-family: 'Bravura', serif;
    }

    /* OSä¾å­˜ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¦æ­¢ */
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
`;
```

#### å³æ™‚æ€§å„ªå…ˆã®åˆ†å²ï¼ˆå…ˆç”Ÿã®å°ãƒ†ã‚¹ãƒˆç”¨ï¼‰

```typescript
// app/api/ai/quick-test/route.ts
export async function POST(req: NextRequest) {
  const { classId, previousLessonId } = await req.json();

  // æ•™æç”Ÿæˆ
  const material = await generateMaterial(/* ... */);

  // å³åº§ã«HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¿”ã™ï¼ˆ1ç§’ä»¥å†…ï¼‰
  const previewHtml = await renderMaterialToHtml(material);

  // PDFç”Ÿæˆã¯éåŒæœŸã§ã‚­ãƒ¥ãƒ¼æŠ•å…¥ï¼ˆ10-30ç§’ã‹ã‹ã‚‹ï¼‰
  const pdfJob = await pdfQueue.add({
    materialId: material.id,
    userId: req.userId,
  });

  return NextResponse.json({
    success: true,
    materialId: material.id,
    previewHtml,  // å³åº§ã«è¡¨ç¤ºå¯èƒ½
    pdfJobId: pdfJob.id,
    message: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºä¸­ã€‚PDFç”Ÿæˆã¯è£ã§é€²è¡Œã—ã¾ã™ã€‚',
  });
}

// ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ãƒãƒ¼ãƒªãƒ³ã‚°ã§PDFå®Œæˆã‚’ç¢ºèª
useEffect(() => {
  if (pdfJobId) {
    const interval = setInterval(async () => {
      const status = await fetch(`/api/export/pdf/status/${pdfJobId}`);
      const { completed, url } = await status.json();

      if (completed) {
        setPdfUrl(url);
        clearInterval(interval);
        showNotification('PDFãŒå®Œæˆã—ã¾ã—ãŸã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚');
      }
    }, 2000);

    return () => clearInterval(interval);
  }
}, [pdfJobId]);
```

### 9.4 MusicXMLå¤‰æ›ã®ç°¡æ˜“åŒ–ãƒ•ãƒ©ã‚°

```typescript
// app/api/export/musicxml/route.ts
exportQueue.process(async (job) => {
  const { materialId } = job.data;
  const material = await db.aiMaterials.findUnique({ where: { id: materialId } });
  const abcBlocks = JSON.parse(material.notation || '[]');

  const musicXmlFiles = await Promise.all(
    abcBlocks.map(async (block: AbcBlock) => {
      const result = await convertAbcToMusicXml(block.abc);

      // abc2xml ãŒè½ã¨ã™è¦ç´ ã‚’æ¤œå‡º
      const hasOrnaments = block.abc.includes('~') || block.abc.includes('T');
      const hasFingeringHints = /\[\d+\]/.test(block.abc);

      const reduction = hasOrnaments || hasFingeringHints;

      return {
        title: block.title,
        path: result.outputPath,
        reduction,  // ç°¡æ˜“åŒ–ãƒ•ãƒ©ã‚°
        droppedElements: reduction ? ['ornaments', 'fingering'] : [],
      };
    })
  );

  return { success: true, files: musicXmlFiles };
});

// UI: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã«è­¦å‘Šè¡¨ç¤º
{musicXmlFiles.some(f => f.reduction) && (
  <div className="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4">
    <p className="text-sm text-yellow-800">
      âš ï¸ ã“ã®MusicXMLã¯ä¸€éƒ¨ã®è£…é£¾éŸ³ç¬¦ã‚„é‹æŒ‡æ³¨è¨˜ãŒçœç•¥ã•ã‚Œã¦ã„ã¾ã™ã€‚
      å®Œå…¨ãªè­œé¢ãŒå¿…è¦ãªå ´åˆã¯PDFå‡ºåŠ›ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
    </p>
  </div>
)}
```

### 9.5 ã‚³ã‚¹ãƒˆæš´ã‚Œå¯¾ç­–

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```typescript
// app/api/ai/materials/route.ts
const DAILY_GENERATION_LIMIT = {
  free: 3,
  pro: 20,
  teacher: 50,
};

export async function POST(req: NextRequest) {
  const userId = req.userId;
  const userTier = await getUserTier(userId);

  // å½“æ—¥ã®ç”Ÿæˆå›æ•°ã‚’ãƒã‚§ãƒƒã‚¯
  const todayCount = await db.aiMaterials.count({
    where: {
      creator_id: userId,
      created_at: {
        gte: new Date(new Date().setHours(0, 0, 0, 0)),
      },
    },
  });

  const limit = DAILY_GENERATION_LIMIT[userTier];

  if (todayCount >= limit) {
    return NextResponse.json({
      success: false,
      error: `æ—¥æ¬¡ç”Ÿæˆä¸Šé™ï¼ˆ${limit}ä»¶ï¼‰ã«é”ã—ã¾ã—ãŸã€‚æ˜æ—¥å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`,
      upgradeRequired: userTier === 'free',
    }, { status: 429 });
  }

  // åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»åŒä¸€ãƒ«ãƒ¼ãƒ—ç®‡æ‰€ã®å†ç”Ÿæˆåˆ¶é™
  const { materialId, loopedBar } = req.body;

  if (materialId && loopedBar) {
    const recentRegenerations = await db.aiMaterials.count({
      where: {
        creator_id: userId,
        metadata: {
          path: ['sourceLoopBar'],
          equals: loopedBar,
        },
        created_at: {
          gte: new Date(Date.now() - 24 * 60 * 60 * 1000), // éå»24æ™‚é–“
        },
      },
    });

    if (recentRegenerations >= 3) {
      return NextResponse.json({
        success: false,
        error: 'ã“ã®ç®‡æ‰€ã®å†ç”Ÿæˆã¯1æ—¥3å›ã¾ã§ã§ã™ã€‚æ—¢å­˜ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚',
      }, { status: 429 });
    }
  }

  // ... é€šå¸¸ã®ç”Ÿæˆå‡¦ç† ...
}
```

### 9.6 Safariå¯¾å¿œã®å®Œå…¨ç‰ˆ

```typescript
// lib/audio/abc-player.ts
class AbcAudioPlayer {
  private audioContext: AudioContext | null = null;
  private resumeOnVisibilityChange = true;

  async init(abc: string) {
    if (!this.audioContext) {
      this.audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
    }

    // åˆå›è§£éŒ 
    if (this.audioContext.state === 'suspended') {
      await this.audioContext.resume();
    }

    // ã‚¿ãƒ–å¾©å¸°æ™‚ã®è‡ªå‹•resumeï¼ˆãƒ¢ãƒã‚¤ãƒ«Safariå¯¾ç­–ï¼‰
    if (this.resumeOnVisibilityChange) {
      document.addEventListener('visibilitychange', async () => {
        if (!document.hidden && this.audioContext?.state === 'suspended') {
          try {
            await this.audioContext.resume();
            console.log('Audio context resumed on tab focus');
          } catch (error) {
            console.error('Failed to resume audio context:', error);
          }
        }
      });
      this.resumeOnVisibilityChange = false; // ä¸€åº¦ã ã‘è¨­å®š
    }

    // ... rest of init ...
  }
}
```

### 9.7 ãƒ«ãƒ¼ãƒ—é¸æŠã®ç²¾åº¦å‘ä¸Š

```typescript
// lib/audio/loop-handler.ts
/**
 * å°ç¯€å¢ƒç•Œã§ã¯ãªãæ‹ä½ç½®ã§æ­£è¦åŒ–
 * æ‹è·¨ããƒ«ãƒ¼ãƒ—ã§ã‚‚ã‚¯ãƒªãƒƒã‚¯ãƒã‚¤ã‚ºã‚’å‡ºã•ãªã„
 */
export function normalizeLoopRange(
  abc: string,
  startBar: number,
  endBar: number
): { startBeat: number; endBeat: number } {
  const measures = parseAbcMeasures(abc);

  let startBeat = 0;
  let endBeat = 0;

  for (let i = 0; i < measures.length; i++) {
    if (i < startBar - 1) {
      startBeat += measures[i].beats;
    }
    if (i < endBar) {
      endBeat += measures[i].beats;
    }
  }

  // æ‹å¢ƒç•Œã«ä¸¸ã‚ã‚‹ï¼ˆ0.25æ‹å˜ä½ï¼‰
  startBeat = Math.floor(startBeat * 4) / 4;
  endBeat = Math.ceil(endBeat * 4) / 4;

  return { startBeat, endBeat };
}

// abcjs.synth.CreateSynth ã«æ‹ä½ç½®ã§æŒ‡å®š
synth.setLoop(startBeat, endBeat, true);
```

### 9.8 å“è³ªã‚¹ã‚³ã‚¢ã®åˆ†é›¢

```typescript
// app/api/ai/materials/route.ts
const quality = {
  syntax_passed: syntaxErrors.length === 0,  // æ§‹æ–‡OK
  pedagogy_passed: analysis.learning_value_score >= QUALITY_THRESHOLD,  // å­¦ç¿’ä¾¡å€¤OK
  learning_value_score: analysis.learning_value_score,
  playability_score: analysis.playability_score,
  // ... ãã®ä»–ã®ã‚¹ã‚³ã‚¢
  validation_passed: syntaxErrors.length === 0 && analysis.learning_value_score >= QUALITY_THRESHOLD,
  review_status: analysis.learning_value_score >= QUALITY_THRESHOLD ? 'approved' : 'draft',
};

// é‹ç”¨ã§ã®åˆ†æãŒå®¹æ˜“ã«
const materialsByQuality = await db.aiMaterials.groupBy({
  by: ['quality.syntax_passed', 'quality.pedagogy_passed'],
  _count: true,
});

// çµæœä¾‹:
// { syntax_passed: true, pedagogy_passed: false, _count: 42 }  // æ§‹æ–‡OKã ãŒå­¦ç¿’ä¾¡å€¤ä¸è¶³
// { syntax_passed: false, pedagogy_passed: true, _count: 3 }   // æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã ãŒå†…å®¹ã¯è‰¯ã„
```

### 9.9 PDFæ”¹ãƒšãƒ¼ã‚¸åˆ¶å¾¡

```typescript
// lib/export/pdf-generator.ts
const pdfStyles = `
  <style>
    /* å„è­œé¢ãƒ–ãƒ­ãƒƒã‚¯ã®æ”¹ãƒšãƒ¼ã‚¸é€”ä¸­åˆ‡ã‚Œã‚’é˜²æ­¢ */
    .notation-block {
      margin: 30px 0;
      page-break-inside: avoid !important;
      -webkit-column-break-inside: avoid !important;
      break-inside: avoid !important;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚‚æ”¹ãƒšãƒ¼ã‚¸é€”ä¸­åˆ‡ã‚Œã‚’é˜²æ­¢ */
    .section {
      page-break-inside: avoid !important;
      break-inside: avoid !important;
    }

    /* é•·ã„è­œé¢ã®å ´åˆã¯æ”¹ãƒšãƒ¼ã‚¸ã‚’è¨±å¯ */
    .notation-block.long {
      page-break-inside: auto;
    }
  </style>
`;

// è­œé¢ã®é•·ã•ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’å‹•çš„ä»˜ä¸
const notationHtml = abcBlocks.map((block, idx) => {
  const isLong = block.abc.split('\n').length > 20; // 20è¡Œä»¥ä¸Š

  return `
    <div class="notation-block ${isLong ? 'long' : ''}">
      <div class="notation-title">${block.title}</div>
      ${renderAbcToSvg(block.abc)}
    </div>
  `;
});
```

---

## 10. MVPå‡ºè·å‰ã®æœ€å°ãƒ†ã‚¹ãƒˆ

### 10.1 ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒ†ã‚¹ãƒˆ

```typescript
// tests/e2e/browser-compatibility.spec.ts
const BROWSERS = ['chromium', 'webkit', 'firefox'];
const DEVICES = ['Desktop', 'iPhone 13', 'iPad Pro'];

describe('Browser Compatibility', () => {
  for (const browserType of BROWSERS) {
    for (const device of DEVICES) {
      test(`${browserType} - ${device}: å†ç”Ÿãƒ»ãƒ«ãƒ¼ãƒ—ãƒ»é€Ÿåº¦å¤‰æ›´ãƒ»PDF`, async ({ page }) => {
        await page.goto('/dashboard/materials/test-material-id');

        // 10å›ç¹°ã‚Šè¿”ã—
        for (let i = 0; i < 10; i++) {
          // å†ç”Ÿ
          await page.click('button[aria-label="å†ç”Ÿ"]');
          await page.waitForTimeout(2000);

          // ãƒ«ãƒ¼ãƒ—è¨­å®š
          await page.click('button[aria-label="ãƒ«ãƒ¼ãƒ—"]');
          await page.dragAndDrop('.measure-1', '.measure-4');

          // é€Ÿåº¦å¤‰æ›´
          await page.click('button:has-text("-10%")');
          await page.waitForTimeout(1000);

          // PDFå‡ºåŠ›
          await page.click('button:has-text("PDFå‡ºåŠ›")');
          await page.waitForSelector('text=PDFãŒå®Œæˆã—ã¾ã—ãŸ', { timeout: 30000 });

          // å¤±æ•—ç‡ã‚’è¨˜éŒ²
          const errors = await page.evaluate(() => window.errors || []);
          expect(errors).toHaveLength(0);
        }
      });
    }
  }
});
```

### 10.2 å°åˆ·å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ

```markdown
# å°åˆ·å“è³ªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

## ãƒ†ã‚¹ãƒˆç’°å¢ƒ
- ãƒ—ãƒªãƒ³ã‚¿1: Canon PIXUS TS8530
- ãƒ—ãƒªãƒ³ã‚¿2: Brother MFC-J6999CDW
- ãƒ—ãƒªãƒ³ã‚¿3: HP LaserJet Pro M404dn

## ç¢ºèªé …ç›®
- [ ] è­œé¢ã®äº”ç·šãŒã«ã˜ã¾ãšã‚¯ãƒªã‚¢ã«å°åˆ·ã•ã‚Œã‚‹
- [ ] é‹æŒ‡æ•°å­—ï¼ˆ1, 2, 3, 4, 5ï¼‰ãŒæ½°ã‚Œãšã«èª­ã‚ã‚‹
- [ ] ä¼‘ç¬¦è¨˜å·ãŒåˆ¤åˆ¥å¯èƒ½
- [ ] ãƒ†ãƒ³ãƒè¨˜å·ï¼ˆBPMè¡¨è¨˜ï¼‰ãŒèª­ã‚ã‚‹
- [ ] ãƒšãƒ¼ã‚¸å¢ƒç•Œã§è­œé¢ãŒé€”ä¸­ã§åˆ‡ã‚Œãªã„
- [ ] A4ç”¨ç´™ã®ä½™ç™½ãŒé©åˆ‡ï¼ˆ20mmï¼‰

## åˆæ ¼åŸºæº–
- 3æ©Ÿç¨®ã™ã¹ã¦ã§ä¸Šè¨˜6é …ç›®ãŒæº€ãŸã•ã‚Œã‚‹ã“ã¨
- 10æšé€£ç¶šå°åˆ·ã—ã¦ã‚‚ã‚¯ã‚ªãƒªãƒ†ã‚£ãŒåŠ£åŒ–ã—ãªã„ã“ã¨
```

### 10.3 æ•™è‚²åŠ¹æœã®äº‹å‰æ¤œè¨¼

```typescript
// scripts/ab-test-setup.ts
/**
 * åŒä¸€ãƒ†ãƒ¼ãƒã®æ•™æA/Bã‚’20åã«é…ä¿¡
 * é”æˆç‡ãƒ»ãƒ†ãƒ³ãƒåˆ°é”ã®å·®åˆ†ã‚’è¨ˆæ¸¬
 */
async function setupAbTest(themeId: string, participantIds: string[]) {
  // Aç‰ˆ: åå¾©å¤šã‚ï¼ˆrepetition_ratio: 0.5ï¼‰
  const materialA = await generateMaterial({
    theme: themeId,
    repetition_ratio: 0.5,
    variation: 'A',
  });

  // Bç‰ˆ: åå¾©å°‘ãªã‚ï¼ˆrepetition_ratio: 0.3ï¼‰
  const materialB = await generateMaterial({
    theme: themeId,
    repetition_ratio: 0.3,
    variation: 'B',
  });

  // ãƒ©ãƒ³ãƒ€ãƒ ã«10åãšã¤å‰²ã‚Šå½“ã¦
  const groupA = participantIds.slice(0, 10);
  const groupB = participantIds.slice(10, 20);

  await db.abTestAssignments.createMany({
    data: [
      ...groupA.map(userId => ({ userId, materialId: materialA.id, group: 'A' })),
      ...groupB.map(userId => ({ userId, materialId: materialB.id, group: 'B' })),
    ],
  });

  // 2é€±é–“å¾Œã«çµæœã‚’é›†è¨ˆ
  setTimeout(async () => {
    const results = await analyzeAbTestResults(themeId);
    console.log('A/Bãƒ†ã‚¹ãƒˆçµæœ:', results);

    // å­¦å†…IRãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    await generateIRReport(themeId, results);
  }, 14 * 24 * 60 * 60 * 1000);
}

async function analyzeAbTestResults(themeId: string) {
  const metrics = await db.query(`
    SELECT
      ab.group,
      AVG(lm.completed::int) as avg_completion_rate,
      AVG(lm.tempo_achieved::float / lm.tempo_target::float) as avg_tempo_achievement,
      AVG(lm.repetition_count) as avg_repetition
    FROM ab_test_assignments ab
    JOIN learning_metrics lm ON ab.user_id = lm.user_id
    WHERE ab.theme_id = $1
    GROUP BY ab.group
  `, [themeId]);

  return {
    groupA: metrics.find(m => m.group === 'A'),
    groupB: metrics.find(m => m.group === 'B'),
    winner: metrics[0].avg_completion_rate > metrics[1].avg_completion_rate ? 'A' : 'B',
  };
}
```

---

## 11. ãƒ“ã‚¸ãƒã‚¹æŒ‡æ¨™ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

### 11.1 å…ˆç”Ÿå‘ã‘ï¼šæ™‚é–“çŸ­ç¸®ã®è¦‹ãˆã‚‹åŒ–

```tsx
// app/dashboard/teacher/analytics/page.tsx
export default function TeacherAnalyticsPage() {
  const [stats, setStats] = useState<TeacherStats | null>(null);

  useEffect(() => {
    fetchTeacherStats().then(setStats);
  }, []);

  if (!stats) return <Loading />;

  return (
    <div className="max-w-6xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">ğŸ“Š æˆæ¥­æº–å‚™ã®æ™‚çŸ­åŠ¹æœ</h1>

      {/* ãƒ¡ã‚¤ãƒ³KPI: æ™‚é–“çŸ­ç¸®ç‡ */}
      <div className="grid grid-cols-3 gap-6 mb-8">
        <Card className="p-6">
          <div className="text-sm text-gray-600 mb-2">å¾“æ¥ã®æº–å‚™æ™‚é–“</div>
          <div className="text-4xl font-bold text-gray-900">{stats.traditional_prep_time}åˆ†</div>
          <div className="text-xs text-gray-500 mt-1">å°ãƒ†ã‚¹ãƒˆ1å›ã‚ãŸã‚Š</div>
        </Card>

        <Card className="p-6">
          <div className="text-sm text-gray-600 mb-2">MUEDä½¿ç”¨æ™‚</div>
          <div className="text-4xl font-bold text-green-600">{stats.mued_prep_time}åˆ†</div>
          <div className="text-xs text-gray-500 mt-1">5åˆ†å‰ç”Ÿæˆ</div>
        </Card>

        <Card className="p-6 bg-green-50 border-green-200">
          <div className="text-sm text-green-800 mb-2">çŸ­ç¸®ç‡</div>
          <div className="text-4xl font-bold text-green-700">{stats.time_saved_percentage}%</div>
          <div className="text-xs text-green-600 mt-1">æœˆé–“ {stats.total_hours_saved}æ™‚é–“å‰Šæ¸›</div>
        </Card>
      </div>

      {/* ç´¯ç©ã‚°ãƒ©ãƒ• */}
      <Card className="p-6">
        <h2 className="text-xl font-semibold mb-4">ğŸ“ˆ ç´¯ç©æ™‚çŸ­åŠ¹æœï¼ˆä»Šå­¦æœŸï¼‰</h2>
        <LineChart
          data={stats.cumulative_time_saved}
          xAxis="week"
          yAxis="hours_saved"
          target={50} // å­¦æœŸç›®æ¨™: 50æ™‚é–“çŸ­ç¸®
        />
      </Card>
    </div>
  );
}
```

### 11.2 å€‹äººå‘ã‘ï¼šæˆæœã®è¦‹ãˆã‚‹åŒ–

```tsx
// app/dashboard/materials/[id]/progress/page.tsx
export default function MaterialProgressPage({ params }: { params: { id: string } }) {
  const { material, metrics } = useMaterialProgress(params.id);

  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">ğŸ¯ å­¦ç¿’ã®è¨˜éŒ²</h1>

      {/* é€²æ—ãƒªãƒ³ã‚° */}
      <div className="flex justify-center mb-8">
        <ProgressRing
          sections={material.metadata.sections}
          completed={metrics.completed_sections}
          size={200}
        />
      </div>

      {/* ãƒ†ãƒ³ãƒåˆ°é”ã®ãƒ’ã‚¹ãƒˆãƒªãƒ¼ */}
      <Card className="p-6 mb-6">
        <h2 className="text-lg font-semibold mb-4">â±ï¸ ãƒ†ãƒ³ãƒåˆ°é”ã®æ¨ç§»</h2>
        <LineChart
          data={metrics.tempo_history}
          xAxis="date"
          yAxis="achieved_bpm"
          target={material.metadata.target_tempo}
        />

        {metrics.tempo_achieved >= material.metadata.target_tempo && (
          <div className="mt-4 bg-green-50 border border-green-200 rounded p-4">
            <p className="text-green-800 font-medium">
              ğŸ‰ ç›®æ¨™ãƒ†ãƒ³ãƒ {material.metadata.target_tempo} BPMã«åˆ°é”ã—ã¾ã—ãŸï¼
            </p>
          </div>
        )}
      </Card>

      {/* è‹¦æ‰‹ç®‡æ‰€ã®æ”¹å–„ */}
      <Card className="p-6">
        <h2 className="text-lg font-semibold mb-4">ğŸ“Š è‹¦æ‰‹ç®‡æ‰€ã®å…‹æœçŠ¶æ³</h2>
        {metrics.weak_sections.map(section => (
          <div key={section.bar} className="flex items-center gap-4 mb-3">
            <div className="w-24 text-sm text-gray-600">å°ç¯€ {section.bar}</div>
            <div className="flex-1">
              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div
                  className="h-full bg-green-600 transition-all"
                  style={{ width: `${section.improvement_rate}%` }}
                />
              </div>
            </div>
            <div className="text-sm font-medium text-green-700">
              +{section.improvement_rate}%
            </div>
          </div>
        ))}
      </Card>
    </div>
  );
}
```

---

*æœ€çµ‚æ›´æ–°: 2025-10-27 | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 3.0*
*è²¬ä»»ã‚’æŒã£ã¦å®Ÿè£…ã§ãã‚‹ä»•æ§˜*
*é‹ç”¨ã§æ‰ã‚ã‚‹ãƒã‚¤ãƒ³ãƒˆã‚’äº‹å‰ã«æ½°ã—ãŸç‰ˆ*
