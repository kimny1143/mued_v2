/**
 * HLA PoC - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ (ESMç‰ˆ)
 *
 * ä½¿ã„æ–¹:
 * cd apps/muednote-poc/hla-poc
 * node run-test.mjs
 */

import * as fs from 'fs';

// ========================================
// ãƒ†ã‚¹ãƒˆå…¥åŠ›ãƒ‡ãƒ¼ã‚¿
// ========================================
const testInputs = {
  // ã‚µãƒ³ãƒ—ãƒ«1: å®Ÿéš›ã®ç‹¬ã‚Šè¨€ï¼ˆæ–­ç‰‡çš„ã€æŽ¥ç¶šè©žå¤šã‚ã€æŒ‡ç¤ºèªžå¤šã‚ï¼‰
  realistic_mixed: `
ãˆãƒ¼ã£ã¨ã€ã€ã€
ã“ã“ã•ã‚ã€ã€ã€Dm7ã‹ã‚‰ã•ã‚ã€ã€ã€G7ã§ã€ã€ã€ã‚“ãƒ¼æ™®é€šã™ãŽã‚‹ã‹ãªã‚
ã„ã‚„ã¾ã‚ã€ã“ã‚Œã¯ã“ã‚Œã§
ã‚ã€ãƒ™ãƒ¼ã‚¹ã€ãƒ™ãƒ¼ã‚¹ã‚ã¨ã§ã­
ã†ã‚ã€œã€œã€œã¾ãŸè½ã¡ãŸã€ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€ã¾ã˜ã§ã€ã€ã€
ã‚“ãƒ¼ãƒ¼ãƒ¼
ã‚ã€ãã†ã ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã€ã€ã€BPMã€ã€ã€Spotifyã®ã‚„ã¤ã€èª¿ã¹ãªã„ã¨
ã“ã“ã®ã‚³ãƒ³ãƒ—ã•ã‚ã€ã€ã€ã‚¢ã‚¿ãƒƒã‚¯ã€ã€ã€æ—©ã„ã¨ã•ã‚ã€ãƒ‘ãƒ³ãƒãªããªã‚‹ã‚“ã ã‚ˆã­
ã“ã‚Œå‰ã‚‚ã‚„ã£ãŸãªã€ã€ã€
æ˜Žæ—¥ã¾ã§ã€ãƒ‰ãƒ©ãƒ ã€ã€ã€ã‚„ã‚“ãªã„ã¨ãªã‚
ã‚ã€œã€œã€œãƒ¢ãƒãƒ™ã€ã€ã€ã¾ã‚ã„ã„ã‹
ã‚µãƒ“ã€3åº¦ä¸Šã€ã€ã€ãƒãƒ¢ã‚Šã€ã€ã€åŽšããªã‚Šãã†
`,

  // ã‚µãƒ³ãƒ—ãƒ«2: ã»ã¼æ„Ÿå˜†è©žã¨æŒ‡ç¤ºèªžã®ã¿
  very_fragmented: `
ã‚“ãƒ¼ãƒ¼ãƒ¼
ã“ã“ã€ã€ã€ã“ã“ã‹ãª
ã‚ã€é•ã†
ã„ã‚„ã¾ã‚ã€ã€ã€
ã†ã‚ã€œã€œã€œã€œ
ã‚ã€ã“ã‚Œã“ã‚Œ
ã‚“ãƒ¼ã€ã€ã€ã¡ã‚‡ã£ã¨ä¸Šã’ã¦ã€ã€ã€
ã„ã‚„ã§ã‚‚ãªã‚ã€ã€ã€
ã‚ã€œã€œã€œ
ã“ã“ã¯ã•ã‚ã€ã€ã€ã‚‚ã†ã¡ã‚‡ã£ã¨ã•ã‚ã€ã€ã€ä¸‹ã’ãªã„ã¨ã•ã‚
ã†ã‚“ã€ã€ã€ãã†ãã†
`,

  // ã‚µãƒ³ãƒ—ãƒ«3: ä½œæ¥­ä¸­ã®ç”Ÿã€…ã—ã„ç‹¬ã‚Šè¨€
  raw_session: `
ã‚ã€œã€œã€œå…¨ç„¶ãƒ€ãƒ¡ã 
ãªã‚“ã§ã“ã‚Œã•ã‚ã€ã€ã€ã‚°ãƒ«ãƒ¼ãƒ–å‡ºãªã„ã‚“ã ã‚ˆ
ã‚‚ã†ä½•å›žã‚„ã£ã¦ã‚“ã ã€ã€ã€
ã„ã‚„ã„ã‚„ã€ã€ã€ä¿ºã«ã¯ã€ã€ã€ã„ã‚„ãã‚“ãªã“ã¨è¨€ã£ã¦ã‚‚ã•ã‚
ã¨ã‚Šã‚ãˆãšã€ã€ã€ã‚¯ã‚ªãƒ³ã‚¿ã‚¤ã‚ºã€ã€ã€50%ãã‚‰ã„ã§ã€ã€ã€
ã„ã‚„æ©Ÿæ¢°çš„ã«ãªã‚‹ã—ãªã‚
ã‚‚ã†ã„ã„ã‚ã€ãƒŸãƒƒã‚¯ã‚¹ã€ãƒŸãƒƒã‚¯ã‚¹ã‚„ã‚
ã¦ã‹ã“ã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã€ã€ã€ä½ŽéŸ³ã€ã€ã€è¶³ã‚Šãªãã­ï¼Ÿ
æ˜Žæ—¥ã€ã€ã€çµ¶å¯¾ã“ã‚Œã€ã€ã€çµ‚ã‚ã‚‰ã™
`,

  // ã‚µãƒ³ãƒ—ãƒ«4: ã‚¢ã‚¤ãƒ‡ã‚¢å‡ºã—ä¸­ï¼ˆã§ã‚‚ã‚„ã£ã±ã‚Šæ–­ç‰‡çš„ï¼‰
  idea_fragments: `
ã“ã“ã•ã‚ã€ã€ã€ãƒãƒªãƒªã‚ºãƒ ã€ã€ã€å…¥ã‚ŒãŸã‚‰ã€ã€ã€
3å¯¾4ã§ã€ã€ã€ãƒã‚¤ãƒãƒƒãƒˆã€ã€ã€
ã„ã‚„ã¾ã¦ã€ãƒœãƒ¼ã‚«ãƒ«ã€ã€ã€é‚ªé­”ã—ã¡ã‚ƒã†ã‹ãª
é–“å¥ã€ã€ã€é–“å¥ã§ä½¿ãˆã°ã„ã„ã‹
ã‚ã€ã‚¤ãƒ³ãƒˆãƒ­ã®ã‚·ãƒ³ã‚»ã€ã€ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã€ã€é€†ã«ã—ãŸã‚‰ã€ã€ã€
æ™®é€šé–‹ã„ã¦ãã˜ã‚ƒã‚“ã€ã€ã€é–‰ã˜ã¦ãã€ã€ã€ã§ã€ã‚µãƒ“ã§ãƒãƒ¼ãƒ³ã¨
ã“ã‚Œã„ã„ã‹ã‚‚
ã‚®ã‚¿ãƒ¼ã€ã€ã€ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸‹ã€ã€ã€ãƒ™ãƒ¼ã‚¹ã¨ã€ã€ã€ãƒ¦ãƒ‹ã‚¾ãƒ³ã€ã€ã€ã‚ã‚Šã ãª
`,

  // ã‚µãƒ³ãƒ—ãƒ«5: ãƒŸãƒƒã‚¯ã‚¹ä½œæ¥­ä¸­ï¼ˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ»æŠ€è¡“ç”¨èªžå¤šã‚ï¼‰
  mixing_session: `
ã‚“ãƒ¼ãƒ¼ãƒ¼ã€ã“ã®ã‚­ãƒƒã‚¯ã€ã€ã€ã‚‚ã†ã¡ã‚‡ã£ã¨ã€ã€ã€ã‚µãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ã€ã€
ã‚ã€Serumã®ãƒ—ãƒªã‚»ãƒƒãƒˆã€ã€ã€ã©ã“ã ã£ã‘ã€ã€ã€
ã„ã‚„ã“ã‚Œã€ã€ã€808ã¨ã¶ã¤ã‹ã£ã¦ã‚“ãªã€ã€ã€ã‚µã‚¤ãƒ‰ãƒã‚§ã‚¤ãƒ³ã‹ã€ã€ã€
ã†ã‚ã€œã€œAbletonã¾ãŸãƒ•ãƒªãƒ¼ã‚ºã—ãŸã€ã€ã€ãªã‚“ãªã®ã€ã€ã€
ã“ã®ã‚·ãƒ³ã‚»ã€ã€ã€ãƒ­ãƒ¼ãƒ‘ã‚¹ã€ã€ã€ã„ã‚„ã€ãƒã‚¤ãƒ‘ã‚¹ã‹ã€ã€ã€ã©ã£ã¡ã ã€ã€ã€
ã¦ã‹CPUã€ã€ã€ã‚‚ã†80%ã€ã€ã€é‡ã™ãŽã€ã€ã€
ãƒªãƒãƒ¼ãƒ–ã€ã€ã€ãƒ—ãƒ¬ãƒ¼ãƒˆç³»ã€ã€ã€ã„ã‚„ãƒ›ãƒ¼ãƒ«ã€ã€ã€ã©ã£ã¡ãŒã„ã„ã‹ãªã€ã€ã€
ã‚ã€ã‚¹ãƒã‚¢ã€ã€ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ã€ã€ã‚‚ã†ä¸€å€‹ã€ã€ã€ãƒ‘ãƒ³ãƒè¶³ã‚Šãªã„ã€ã€ã€
ãƒœãƒ¼ã‚«ãƒ«ã€ã€ã€ãƒ‡ã‚£ã‚¨ãƒƒã‚µãƒ¼ã€ã€ã€ã‚‚ã†ã¡ã‚‡ã£ã¨å¼·ã‚ã«ã€ã€ã€
ãƒžã‚¹ã‚¿ãƒ¼ã€ã€ã€-6dBã€ã€ã€ã„ã‚„ã‚‚ã†ã¡ã‚‡ã„ä¸‹ã’ãªã„ã¨ã€ã€ã€
ã‚“ãƒ¼ã€ã€ã€ã“ã®ãƒ‘ãƒƒãƒ‰ã€ã€ã€Attackã€ã€ã€é…ã™ãŽã€ã€ã€
Pro-Q3ã€ã€ã€ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯EQã€ã€ã€ã“ã“ã«ã€ã€ã€
éŸ³åœ§ã€ã€ã€ã¾ã è¶³ã‚Šãªã„ã€ã€ã€ã§ã‚‚ã“ã‚Œä»¥ä¸Šã‚„ã‚‹ã¨ã€ã€ã€æ½°ã‚Œã‚‹ã€ã€ã€
`,

  // ã‚µãƒ³ãƒ—ãƒ«6: æ·±å¤œãƒ†ãƒ³ã‚·ãƒ§ãƒ³ï¼ˆç–²åŠ´ãƒ»ç„¦ã‚Šãƒ»é›‘å¿µï¼‰
  late_night: `
ãˆã€ã‚‚ã†3æ™‚ã€ã€ã€ãƒžã‚¸ã‹ã€ã€ã€
ã‚ãƒ¼ã€ã€ã€ã‚‚ã†ä½•å›žè´ã„ãŸã‹ã‚ã‹ã‚“ãªã„ã€ã€ã€è€³ãƒã‚«ã«ãªã£ã¦ããŸã€ã€ã€
ã¦ã‹ãƒŸãƒƒã‚¯ã‚¹ã€ã€ã€ãƒ¢ãƒŽã§ç¢ºèªã€ã€ã€ã—ã¦ãªã‹ã£ãŸã€ã€ã€ã‚„ã°ã€ã€ã€
ã†ã‚ã€ã€ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ã€ã€ä¿å­˜ã—ã¦ãªã‹ã£ãŸã€ã€ã€ã‚ã¶ãªã€ã€ã€
ã‚ãƒ¼ã€ã€ã€ã‚‚ã†é›†ä¸­åŠ›ã€ã€ã€åˆ‡ã‚ŒãŸã€ã€ã€ä¼‘æ†©ã€ã€ã€
ã¦ã‹ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³ã€ã€ã€è€³ç—›ã„ã€ã€ã€éŸ³é‡ä¸‹ã’ãªã„ã¨ã€ã€ã€
ã‚“ãƒ¼ã€ã€ã€ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã€ã€ã€ã¨æ¯”ã¹ã‚‹ã¨ã€ã€ã€å…¨ç„¶ãƒ€ãƒ¡ã ãªã€ã€ã€
ã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€ã€ã€ä¿®æ­£ã€ã€ã€æ˜Žæ—¥ã¾ã§ã€ã€ã€ã†ã‚ã€ã€ã€å¿˜ã‚Œã¦ãŸã€ã€ã€
æ˜Žæ—¥ã€ã€ã€çµ¶å¯¾ã“ã‚Œã€ã€ã€çµ‚ã‚ã‚‰ã™ã€ã€ã€
`,

  // ã‚µãƒ³ãƒ—ãƒ«7: æ©Ÿæãƒˆãƒ©ãƒ–ãƒ«ç³»
  tech_trouble: `
FLã®ãƒ”ã‚¢ãƒŽãƒ­ãƒ¼ãƒ«ã€ã€ã€ãªã‚“ã‹ãƒã‚°ã£ã¦ã­ï¼Ÿã€ã€ã€
MIDIã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã€ã€ã€ã¾ãŸèªè­˜ã—ãªã„ã€ã€ã€ãƒ‰ãƒ©ã‚¤ãƒã‹ãªã€ã€ã€
ã†ã‚ã€œã€œã€œwavæ›¸ãå‡ºã—ã€ã€ã€ã¾ãŸå¤±æ•—ã€ã€ã€ãªã‚“ã§ã€ã€ã€
Kontaktã€ã€ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã€ã€ã¾ãŸå¢—ãˆãŸã€ã€ã€SSDè¶³ã‚Šãªã„ã€ã€ã€
ã‚ãƒ¼ã€ã€ã€ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€ã€ã€64bitå¯¾å¿œã—ã¦ãªã„ã€ã€ã€æ¨ã¦ã‚‹ã‹ã€ã€ã€
iZotopeã€ã€ã€Ozoneã€ã€ã€ç«‹ã¡ä¸Šã’ã¦ã€ã€ã€ã‚ã‚Œé‡ã„ã‚“ã ã‚ˆãªã€ã€ã€
ã¦ã‹ã“ã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã€ã€ã€ä½ŽéŸ³ã€ã€ã€è¶³ã‚Šãªãã­ï¼Ÿã€ã€ã€
`,

  // ã‚µãƒ³ãƒ—ãƒ«8: å‰µä½œã‚¢ã‚¤ãƒ‡ã‚¢çˆ†ç™º
  creative_burst: `
ã‚ã€ã“ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã€ã€ã€Cãƒ¡ã‚¸ãƒ£ãƒ¼ãƒšãƒ³ã‚¿ã§ã€ã€ã€ã„ã‘ãã†ã€ã€ã€
ã“ã®è»¢èª¿ã€ã€ã€Abã‹ã‚‰ã€ã€ã€Bbã«ã€ã€ã€ã„ã‘ã‚‹ã‹ãªã€ã€ã€
ã“ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã€ã€ã€ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šã’ãŸã‚‰ã€ã€ã€ã©ã†ãªã‚‹ã€ã€ã€
ã“ã®ãƒœãƒ¼ã‚«ãƒ«ãƒãƒ§ãƒƒãƒ—ã€ã€ã€é€†å†ç”Ÿã€ã€ã€ã‚ã‚Šã€ã€ã€ã‹ãªã€ã€ã€
ã“ã“ã€ã€ã€ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹ã€ã€ã€å…¥ã‚ŒãŸã‚‰ã€ã€ã€ã‚¨ãƒ¢ããªã‚Šãã†ã€ã€ã€
ã“ã®ãƒ‰ãƒ©ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã€ã€4ã¤æ‰“ã¡ã˜ã‚ƒã€ã€ã€ã¤ã¾ã‚“ãªã„ãªã€ã€ã€
ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã€ã€ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã€ã€æã‹ãªã„ã¨ã€ã€ã€
ã“ã®ã‚¢ãƒ«ãƒšã‚¸ã‚ªã€ã€ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã€ã€å¤‰ãˆãŸã»ã†ãŒã€ã€ã€ã„ã„ã‹ãªã€ã€ã€
ã“ã“ã®ã‚®ã‚¿ãƒ¼ã€ã€ã€ãƒ€ãƒ–ãƒªãƒ³ã‚°ã€ã€ã€å·¦å³ã«æŒ¯ã£ã¦ã€ã€ã€
`,

  // ã‚µãƒ³ãƒ—ãƒ«9: æ‚©ã¿ãƒ»è¿·ã„ç³»
  uncertainty: `
ãˆãƒ¼ã£ã¨ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã€ã€ã€è‘—ä½œæ¨©ã€ã€ã€å¤§ä¸ˆå¤«ã ã‚ˆãªã€ã€ã€
ã†ãƒ¼ã‚“ã€ã€ã€ã“ã®ãƒ¡ãƒ­ãƒ‡ã‚£ã€ã€ã€ã©ã£ã‹ã§èžã„ãŸæ°—ãŒã™ã‚‹ã€ã€ã€ã‚„ã°ã„ã‹ãªã€ã€ã€
ãƒ´ã‚¡ãƒ¼ã‚¹ã®ã“ã“ã€ã€ã€ã‚‚ã†ã¡ã‚‡ã£ã¨ã€ã€ã€ã‚¹ãƒšãƒ¼ã‚¹æ¬²ã—ã„ãªã€ã€ã€
ã“ã®æ›²ã€ã€ã€132BPMã§ã€ã€ã€ã„ã„ã®ã‹ãªã€ã€ã€128ã®æ–¹ãŒã€ã€ã€
ã¦ã‹ã“ã®æ›²ã€ã€ã€ã‚­ãƒ¼ãªã«ã€ã€ã€F#mï¼Ÿã€ã€ã€å¿˜ã‚ŒãŸã€ã€ã€
ã“ã“ã®ã€ã€ã€ãƒ–ãƒ¬ã‚¤ã‚¯ã€ã€ã€4å°ç¯€ã˜ã‚ƒã€ã€ã€é•·ã„ã‹ã€ã€ã€
ã“ã®ã‚­ãƒ¡ã€ã€ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€ã€ã€16åˆ†å‰ã«ã€ã€ã€ãšã‚‰ã™ã€ã€ã€
Sub Bassã€ã€ã€30Hzã‚ãŸã‚Šã€ã€ã€ã¡ã‚‡ã£ã¨ãƒ–ãƒ¼ã‚¹ãƒˆã€ã€ã€
Spliceã§ã€ã€ã€ãƒã‚¤ãƒãƒƒãƒˆã€ã€ã€æŽ¢ã•ãªã„ã¨ã€ã€ã€
`,
};

// ========================================
// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
// ========================================
const HLA_SYSTEM_PROMPT = `ã‚ãªãŸã¯éŸ³æ¥½åˆ¶ä½œè€…ã®æ€è€ƒãƒ­ã‚°ã‚’æ•´ç†ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

## å…¥åŠ›
éŸ³æ¥½åˆ¶ä½œä¸­ã®ç‹¬ã‚Šè¨€ã‚’æ–‡å­—èµ·ã“ã—ã—ãŸã€Œä¹±æ–‡ã€ãŒå…¥åŠ›ã•ã‚Œã¾ã™ã€‚
- æ–‡æ³•çš„ã«ä¸å®Œå…¨
- ã€Œã€ã€ã€ã€ã€Œã€œã€œã€œã€ãªã©ã®é–“å»¶ã³è¡¨ç¾ãŒå¤šã„
- ã€Œã“ã“ã€ã€Œã“ã‚Œã€ãªã©æŒ‡ç¤ºèªžãŒå¤šãã€æ–‡è„ˆãŒãªã„ã¨æ„å‘³ä¸æ˜Ž
- æ„Ÿå˜†è©žã ã‘ã®è¡Œã‚‚å¤šã„ï¼ˆã€Œã‚“ãƒ¼ãƒ¼ãƒ¼ã€ã€Œã‚ã€œã€œã€œã€ã€Œã†ã‚ã€œã€œã€ï¼‰

## ã‚¿ã‚¹ã‚¯
1. **ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ž**: æ„å‘³ã®ã‚ã‚‹ç™ºè¨€ã‚’ä»¥ä¸‹ã®4ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ž
   - idea: ã‚¢ã‚¤ãƒ‡ã‚¢ã€è©¦ã—ã¦ã¿ãŸã„ã“ã¨ã€å‰µé€ çš„ãªæ€ã„ã¤ã
   - todo: ã‚„ã‚‹ã¹ãã“ã¨ã€ã‚¿ã‚¹ã‚¯ã€ç· ã‚åˆ‡ã‚Šé–¢é€£
   - tips: å­¦ã³ã€æ°—ã¥ãã€ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã€è¦šãˆã¦ãŠããŸã„ã“ã¨
   - frustration: æ„šç—´ã€ä¸æº€ã€ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ä½Žä¸‹ã®åéœ²

2. **è¦ç´„**: ã‚»ãƒƒã‚·ãƒ§ãƒ³å…¨ä½“ã‚’æŠŠæ¡ã§ãã‚‹è¦ç´„ã‚’ç”Ÿæˆ
   - **é‡è¦**: æŠ½è±¡åŒ–ã—ã™ãŽãªã„ã€‚å…·ä½“çš„ãªå†…å®¹ï¼ˆã‚³ãƒ¼ãƒ‰é€²è¡Œã€BPMã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³åãªã©ï¼‰ã‚’æ®‹ã™
   - ã€ŒéŸ³æ¥½çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è€ƒãˆã¦ã„ãŸã€ã§ã¯ãªãã€ŒDm7-G7ã®é€²è¡Œã‚’æ¤œè¨Žã€ã®ã‚ˆã†ã«

## æ–­ç‰‡çš„å…¥åŠ›ã¸ã®å¯¾å‡¦
- ã€Œã“ã“ã€ã€Œã“ã‚Œã€ãªã©ã®æŒ‡ç¤ºèªžã¯ã€å‰å¾Œã®æ–‡è„ˆã‹ã‚‰æŽ¨æ¸¬ã—ã¦è£œå®Œã™ã‚‹ã‹ã€ãã®ã¾ã¾æ®‹ã™
- æ„Ÿå˜†è©žã®ã¿ï¼ˆã€Œã‚“ãƒ¼ãƒ¼ãƒ¼ã€ã€Œã‚ã€œã€œã€ï¼‰ã¯**ã‚¹ã‚­ãƒƒãƒ—**
- æ–‡ãŒé€”åˆ‡ã‚Œã¦ã„ã¦ã‚‚ã€æ„å›³ãŒèª­ã¿å–ã‚Œã‚Œã°æŠ½å‡ºã™ã‚‹
  - ä¾‹: ã€Œã“ã“ã•ã‚ã€ã€ã€ã‚‚ã†ã¡ã‚‡ã£ã¨ã•ã‚ã€ã€ã€ä¸‹ã’ãªã„ã¨ã•ã‚ã€â†’ã€Œï¼ˆä½•ã‹ã‚’ï¼‰ä¸‹ã’ã‚‹å¿…è¦ãŒã‚ã‚‹ã€
- æƒ…å ±ãŒå°‘ãªã™ãŽã‚‹å ´åˆã¯ã€ç„¡ç†ã«è§£é‡ˆã›ãšã€Œä¸æ˜Žã€ã¨ã—ã¦ã‚ˆã„

## åˆ†é¡žã®ã‚³ãƒ„
- ã€Œã€œã‹ã‚‚ã€ã€Œã€œã—ãŸã‚‰ã€ã€Œã€œã‚ã‚Šã ãªã€ã¯idea
- ã€Œã€œã—ãªã„ã¨ã€ã€Œæ˜Žæ—¥ã¾ã§ã€ã€Œã‚„ã‚“ãªã„ã¨ã€ã¯todo
- ã€Œã€œã™ã‚‹ã¨ã€œãªã‚‹ã‚“ã ã‚ˆã­ã€ã€Œå‰ã‚‚ã‚„ã£ãŸã€ã¯tipsï¼ˆçµŒé¨“ã‹ã‚‰ã®å­¦ã³ï¼‰
- ã€Œã‚‚ã†ã€ã€Œãªã‚“ã§ã€ã€Œãƒžã‚¸ã§ã€ã€Œãƒ€ãƒ¡ã ã€ãªã©ãƒã‚¬ãƒ†ã‚£ãƒ–æ„Ÿæƒ…ã¯frustration

## æ·±åº¦ç¶­æŒã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### NGä¾‹ï¼ˆæŠ½è±¡åŒ–ã—ã™ãŽï¼‰
- âŒ ã€Œã‚³ãƒ¼ãƒ‰é€²è¡Œã«ã¤ã„ã¦è€ƒãˆã¦ã„ãŸã€
- âŒ ã€Œãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«å•é¡ŒãŒã‚ã£ãŸã€

### OKä¾‹ï¼ˆå…·ä½“æ€§ã‚’ä¿æŒï¼‰
- âœ… ã€ŒDm7â†’G7â†’Cmaj7ã®é€²è¡Œã‚’æ¤œè¨Žã€æ™®é€šã™ãŽã‚‹ã‹æ‚©ã‚“ã§ã„ãŸã€
- âœ… ã€Œã‚³ãƒ³ãƒ—ã®ã‚¢ã‚¿ãƒƒã‚¯ãŒæ—©ã™ãŽã¦ãƒ‘ãƒ³ãƒãŒãªããªã‚‹å•é¡Œã«æ°—ã¥ã„ãŸã€

### å›ºæœ‰åè©žãƒ»æ•°å€¤ã¯å¿…ãšæ®‹ã™
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³åã€æ¥½å™¨åã€ã‚³ãƒ¼ãƒ‰åã€ã‚¹ã‚±ãƒ¼ãƒ«åã€BPMã€å‘¨æ³¢æ•°ï¼ˆHzï¼‰

## å‡ºåŠ›å½¢å¼
ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

const HLA_OUTPUT_SCHEMA = `{
  "items": [
    {
      "category": "idea" | "todo" | "tips" | "frustration",
      "content": "æ•´ç†ã•ã‚ŒãŸå†…å®¹ï¼ˆå…ƒã®è¨€è‘‰ã‚’ãªã‚‹ã¹ãæ´»ã‹ã™ï¼‰",
      "context": "å¿…è¦ã«å¿œã˜ã¦è£œè¶³"
    }
  ],
  "summary": {
    "mainFocus": "ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ä¸»ã«å–ã‚Šçµ„ã‚“ã§ã„ãŸã“ã¨ï¼ˆå…·ä½“çš„ã«ï¼‰",
    "keyInsights": ["é‡è¦ãªæ°—ã¥ã"],
    "mood": "productive" | "creative" | "frustrated" | "learning" | "mixed",
    "nextActions": ["æ˜Žç¢ºãªTODO"]
  },
  "meta": {
    "totalItems": æ•°å€¤,
    "categoryCounts": { "idea": N, "todo": N, "tips": N, "frustration": N }
  }
}`;

function buildHLAPrompt(transcription) {
  return `${HLA_SYSTEM_PROMPT}

## å‡ºåŠ›ã‚¹ã‚­ãƒ¼ãƒž
\`\`\`json
${HLA_OUTPUT_SCHEMA}
\`\`\`

## å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
\`\`\`
${transcription}
\`\`\`

ä¸Šè¨˜ã®ä¹±æ–‡ã‚’åˆ†æžã—ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;
}

// ========================================
// ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
// ========================================
function loadEnv() {
  const envPath = '/Users/kimny/Dropbox/_DevProjects/mued/mued_v2/.env.local';
  if (fs.existsSync(envPath)) {
    const content = fs.readFileSync(envPath, 'utf-8');
    content.split('\n').forEach((line) => {
      const match = line.match(/^([^=]+)=(.*)$/);
      if (match && !process.env[match[1]]) {
        process.env[match[1]] = match[2];
      }
    });
    console.log(`ðŸ“ ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿: ${envPath}`);
  }
}

loadEnv();

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
if (!OPENAI_API_KEY) {
  console.error('âŒ OPENAI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
  process.exit(1);
}

// ãƒ¢ãƒ‡ãƒ«: gpt-4.1-mini (å˜ç´”ç”Ÿæˆã‚¿ã‚¹ã‚¯å‘ã‘)
const MODEL = 'gpt-4.1-mini';

// ========================================
// API å‘¼ã³å‡ºã—
// ========================================
async function callOpenAI(prompt) {
  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${OPENAI_API_KEY}`,
    },
    body: JSON.stringify({
      model: MODEL,
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.3,
      max_tokens: 2000,
    }),
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`OpenAI API Error: ${response.status} - ${error}`);
  }

  const data = await response.json();
  return data.choices[0].message.content;
}

function parseJSON(raw) {
  const jsonMatch = raw.match(/```json\s*([\s\S]*?)\s*```/) || raw.match(/(\{[\s\S]*\})/);
  if (!jsonMatch) return null;
  try {
    return JSON.parse(jsonMatch[1]);
  } catch {
    return null;
  }
}

// ========================================
// çµæžœè¡¨ç¤º
// ========================================
function printResult(name, input, output) {
  console.log('\n' + '='.repeat(60));
  console.log(`ðŸ“ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: ${name}`);
  console.log('='.repeat(60));

  console.log('\nã€å…¥åŠ›ï¼ˆä¹±æ–‡ï¼‰æŠœç²‹ã€‘');
  console.log(input.trim().substring(0, 150) + '...');

  console.log('\nã€åˆ†é¡žçµæžœã€‘');
  const emoji = { idea: 'ðŸ’¡', todo: 'âœ…', tips: 'ðŸ“š', frustration: 'ðŸ˜¤' };
  output.items.forEach((item, i) => {
    console.log(`  ${i + 1}. ${emoji[item.category] || 'â€¢'} [${item.category}] ${item.content}`);
  });

  console.log('\nã€è¦ç´„ã€‘');
  console.log(`  ä¸»ãªå–ã‚Šçµ„ã¿: ${output.summary.mainFocus}`);
  console.log(`  ãƒ ãƒ¼ãƒ‰: ${output.summary.mood}`);
  if (output.summary.keyInsights?.length) {
    console.log('  é‡è¦ãªæ°—ã¥ã:');
    output.summary.keyInsights.forEach((i) => console.log(`    - ${i}`));
  }
  if (output.summary.nextActions?.length) {
    console.log('  æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:');
    output.summary.nextActions.forEach((a) => console.log(`    - ${a}`));
  }

  console.log('\nã€ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚«ã‚¦ãƒ³ãƒˆã€‘');
  console.log(`  ${JSON.stringify(output.meta.categoryCounts)}`);
}

// ========================================
// ãƒ¡ã‚¤ãƒ³
// ========================================
async function main() {
  console.log('ðŸš€ HLA PoC ãƒ†ã‚¹ãƒˆé–‹å§‹');
  console.log(`   ãƒ¢ãƒ‡ãƒ«: ${MODEL}\n`);

  for (const [name, input] of Object.entries(testInputs)) {
    console.log(`\nðŸ”„ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­: ${name}...`);

    const prompt = buildHLAPrompt(input);
    const startTime = Date.now();

    try {
      const rawOutput = await callOpenAI(prompt);
      const elapsed = Date.now() - startTime;
      console.log(`   â±ï¸  å‡¦ç†æ™‚é–“: ${elapsed}ms`);

      const parsed = parseJSON(rawOutput);
      if (parsed) {
        printResult(name, input, parsed);
      } else {
        console.log('âŒ JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—');
        console.log('Raw:', rawOutput.substring(0, 500));
      }
    } catch (error) {
      console.error(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }

    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
    await new Promise((r) => setTimeout(r, 1500));
  }

  console.log('\nâœ… ãƒ†ã‚¹ãƒˆå®Œäº†');
}

main();
