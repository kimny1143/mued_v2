# Prisma Directory æ•´ç†è¨ˆç”»

## ç¾åœ¨ã®çŠ¶æ³
prismaãƒ•ã‚©ãƒ«ãƒ€ã«è¤‡æ•°ã®SQLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒæ•£åœ¨ã—ã€DBãƒªã‚»ãƒƒãƒˆå¾Œã«ä½•ã‚’å®Ÿè¡Œã™ã¹ãã‹ä¸æ˜ç¢ºã€‚

## æ•´ç†æ–¹é‡

### ğŸŸ¢ ä¿æŒã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

#### 1. å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«
- `schema.prisma` - **ãƒ¡ã‚¤ãƒ³**: Prismaã‚¹ã‚­ãƒ¼ãƒå®šç¾©
- `migrations/` - Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´

#### 2. çµ±åˆåˆæœŸåŒ–ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ–°è¦ä½œæˆï¼‰
- `post-reset-init.sql` - **çµ±åˆ**: DBãƒªã‚»ãƒƒãƒˆå¾Œã®ä¸€æ‹¬åˆæœŸåŒ–
- `rls-policies.sql` - RLSãƒãƒªã‚·ãƒ¼å®šç¾©
- `seed/` - åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥

### ğŸ”´ å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå¤ã„ãƒ»é‡è¤‡ãƒ»åˆ†æ•£ï¼‰

#### åˆ†æ•£ã—ãŸSQLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- `auth_user_sync_trigger.sql` - çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒãƒ¼ã‚¸
- `setup-auth-sync.sql` - é‡è¤‡æ©Ÿèƒ½
- `setup-auth-sync-fixed.sql` - é‡è¤‡æ©Ÿèƒ½
- `complete_init_migration.sql` - å¤ã„çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«
- `create-stripe-subscriptions-view.sql` - çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒãƒ¼ã‚¸

## æ•´ç†å¾Œã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
prisma/
â”œâ”€â”€ README.md                    # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ schema.prisma               # Prismaã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”œâ”€â”€ post-reset-init.sql         # ğŸ”¥ çµ±åˆåˆæœŸåŒ–SQL
â”œâ”€â”€ rls-policies.sql            # ğŸ”’ RLSãƒãƒªã‚·ãƒ¼å®šç¾©
â”œâ”€â”€ migrations/                 # Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â””â”€â”€ 20250526010325_init_with_approval_flow/
â””â”€â”€ seed/                       # åˆæœŸãƒ‡ãƒ¼ã‚¿
    â”œâ”€â”€ roles.sql              # ãƒ­ãƒ¼ãƒ«å®šç¾©
    â”œâ”€â”€ test-users.sql         # ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼
    â””â”€â”€ sample-data.sql        # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
```

## DBãƒªã‚»ãƒƒãƒˆå¾Œã®åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼

### 1. Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```bash
npx prisma migrate reset --force
npx prisma generate
```

### 2. çµ±åˆåˆæœŸåŒ–SQLå®Ÿè¡Œ
```bash
# Supabase SQL Editorã§å®Ÿè¡Œ
psql -f prisma/post-reset-init.sql
```

### 3. åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
```bash
npm run seed
```

### 4. å‹•ä½œç¢ºèª
```bash
npm run check:user
npm run debug:frontend
```

## çµ±åˆåˆæœŸåŒ–SQLã®å†…å®¹

### post-reset-init.sql ã«å«ã¾ã‚Œã‚‹æ©Ÿèƒ½
1. **åŸºæœ¬ãƒ­ãƒ¼ãƒ«ä½œæˆ** (Student, Mentor, Admin)
2. **èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸã‚·ã‚¹ãƒ†ãƒ ** (ãƒˆãƒªã‚¬ãƒ¼ + é–¢æ•°)
3. **RLSãƒãƒªã‚·ãƒ¼è¨­å®š** (å…¨ãƒ†ãƒ¼ãƒ–ãƒ«)
4. **Stripeé–¢é€£è¨­å®š** (æ¨©é™ + ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹)
5. **åˆæœŸæ¨©é™è¨­å®š** (anon, authenticated, service_role)
6. **å‹•ä½œç¢ºèªé–¢æ•°** (ãƒ†ã‚¹ãƒˆç”¨)

### å®Ÿè¡Œé †åºã®ä¿è¨¼
- ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ãŸå®Ÿè¡Œé †åº
- ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
- å†ªç­‰æ€§ã®ç¢ºä¿ï¼ˆé‡è¤‡å®Ÿè¡Œå¯èƒ½ï¼‰

## é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### æ—¥å¸¸é–‹ç™ºæ™‚
```bash
# é€šå¸¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
npx prisma migrate dev --name feature_name

# ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´å¾Œ
npx prisma generate
```

### å¤§ããªå¤‰æ›´æ™‚
```bash
# å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
npm run reset:dev

# åˆæœŸåŒ–ç¢ºèª
npm run analyze:db
```

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
```bash
# DBçŠ¶æ…‹ç¢ºèª
npm run analyze:db

# æ¨©é™ç¢ºèª
npm run check:supabase-permissions

# æ‰‹å‹•ä¿®æ­£
# Supabase SQL Editorã§å€‹åˆ¥SQLå®Ÿè¡Œ
```

## æ³¨æ„äº‹é …

âš ï¸ **é‡è¦**: `post-reset-init.sql`ã¯æœ¬ç•ªç’°å¢ƒã§ã¯æ…é‡ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

âš ï¸ **ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±**: ãƒªã‚»ãƒƒãƒˆå¾Œã¯å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚

âš ï¸ **æ¨©é™è¨­å®š**: RLSãƒãƒªã‚·ãƒ¼ã¯æœ¬ç•ªç’°å¢ƒã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ç›´çµã—ã¾ã™ã€‚ 